package com.xinyirun.scm.core.system.mapper.business.wms.in.delivery;


import com.baomidou.mybatisplus.core.mapper.BaseMapper;
import com.xinyirun.scm.bean.entity.busniess.wms.in.delivery.BDeliveryEntity;
import com.xinyirun.scm.bean.system.vo.wms.in.delivery.BDeliverySumVo;
import com.xinyirun.scm.bean.system.vo.wms.in.delivery.BDeliveryVo;
import com.xinyirun.scm.bean.system.vo.excel.in.BDeliveryExportVo;
import com.xinyirun.scm.common.constant.DictConstant;
import com.xinyirun.scm.common.constant.SystemConstants;
import org.apache.ibatis.annotations.Param;
import org.apache.ibatis.annotations.Select;
import org.springframework.stereotype.Repository;

import java.util.List;

/**
 * <p>
 * 入库单 Mapper 接口
 * </p>
 *
 * @author xinyirun
 * @since 2024-06-25
 */
@Repository
public interface BDeliveryMapper extends BaseMapper<BDeliveryEntity> {


    String common_select = "  "
            + "      SELECT                                                                                                                         "
            + "             @row_num:= @row_num + 1 as excel_no,                                                                                     "
            + "             t.*,                                                                                                                    "
            + "             t10.no,                                                                                                                 "
            + "             ifnull(t10.order_id, t13.order_id) order_id,                                                                             "
            + "             ifnull(t10.order_type, t13.order_type) order_type,                                                                      "
            + "             t.price*t.actual_count total_price,                                                                                     "
            + "             t13.primary_quantity,                                                                                                   "
            + "             t13.car_count,                                                                                                          "
            + "             ifnull(t19.order_no ,t23.order_no) order_no,                                                                            "
            + "             ifnull(t19.ship_name ,t23.ship_name) ship_name ,                                                                        "
            + "             ifnull(t19.contract_no ,t23.contract_no) contract_no ,                                                                  "
            + "             ifnull(t19.contract_dt ,t23.contract_dt) contract_dt ,                                                                  "
            + "             ifnull(t19.contract_num ,t23.contract_num) contract_num,                                                                "
            + "             t13.pound_file ,                                                                                                        "
            + "             t13.photo_file ,                                                                                                        "
            + "             t13.inspection_file ,                                                                                                   "
            + "             t13.goods_file ,                                                                                                        "
            + "             t3.extra_code,                                                                                                          "
            + "             t3.waybill_code,                                                                                                        "
            + "             t3.code as plan_code,                                                                                                   "
            + "             t3.id as plan_id,                                                                                                       "
            + "             t10.code as plan_son_code,                                                                                              "
            + "             t15.label as status_name,                                                                                               "
            + "             ifnull(t16.label,t21.label) as type_name,                                                                               "
            + "             t17.label as bill_type_name,                                                                                            "
            + "             ifnull(t4.short_name,t4.name) as consignor_name,                                                                        "
            + "             ifnull(t5.short_name,t5.name) as owner_name,                                                                            "
            + "             ifnull(t6.short_name,t6.name) as customer_name,                                                                         "
            + "             ifnull(t9.short_name,t9.name) as warehouse_name,                                                                        "
            + "             t9.name as warehouse_full_name,                                                                        "
            + "             t7.name as bin_name,                                                                                                    "
            + "             t8.name as location_name,                                                                                               "
            + "             t11.spec,                                                                                                               "
            + "             t11.pm,                                                                                                                 "
            + "             t12.name as goods_name,                                                                                                 "
            + "             t18.src_unit as unit_name,                                                                                              "
            + "             t1.name as c_name,                                                                                                      "
            + "             t14.name as e_name,                                                                                                     "
            + "             t2.name as u_name,                                                                                                      "
            + "             t20.remark as cancel_remark,                                                                                            "
            + "             t.vehicle_no,                                                                                                           "
            + "             t.cancel_audit_dt,                                                                                                      "
            + "             t26.name as cancel_audit_name                                                                                           "
            + "        FROM                                                                                                                         "
            + "   	       b_delivery t                                                                                                                 "
            + "   LEFT JOIN m_staff t1 ON t.c_id = t1.id                                                                                            "
            + "   LEFT JOIN m_staff t2 ON t.u_id = t2.id                                                                                            "
            + "   LEFT JOIN m_staff t14 ON t.e_id = t14.id                                                                                          "
            + "   LEFT JOIN b_delivery_extra t13 ON t13.delivery_id = t.id                                                                                      "
            + "   LEFT JOIN b_in_plan_detail t10 ON t10.id = t.plan_detail_id                                                                       "
            + "   LEFT JOIN b_in_plan t3 ON t3.id = t.plan_id                                                                                       "
            + "   LEFT JOIN b_order t19 on t10.order_id = t19.serial_id and t10.order_type = t19.serial_type                                        "
            + "   LEFT JOIN b_order t23 on t13.order_id = t23.serial_id and t13.order_type = t23.serial_type                                        "
            + "   LEFT JOIN m_customer t4 ON t.consignor_id = t4.id                                                                                 "
            + "   LEFT JOIN m_owner t5 ON t.owner_id = t5.id                                                                                        "
            + "   LEFT JOIN m_customer t6 ON t19.customer_id = t6.id                                                                                "
            + "   LEFT JOIN m_bin t7 ON t7.id = t.bin_id                                                                                            "
            + "   LEFT JOIN m_location t8 ON t8.id = t.location_id                                                                                  "
            + "   LEFT JOIN m_warehouse t9 ON t9.id = t.warehouse_id                                                                                "
            // 仓库权限
            + "   LEFT JOIN m_goods_spec t11 ON t11.id = t.sku_id                                                                                   "
            + "   LEFT JOIN m_goods_spec_prop t24 ON t11.prop_id = t24.id      "
            + "   LEFT JOIN m_goods t12 ON t12.id = t11.goods_id                                                                                    "
            + "   LEFT JOIN v_dict_info t15 ON t15.code = '" + DictConstant.DICT_B_DELIVERY_STATUS + "' and t.status = t15.dict_value                     "
            + "   LEFT JOIN v_dict_info t16 ON t16.code = '" + DictConstant.DICT_B_DELIVERY_TYPE + "' and t3.type = t16.dict_value                        "
            + "   LEFT JOIN v_dict_info t17 ON t17.code = '" + DictConstant.DICT_B_DELIVERY_BUSINESS_TYPE + "' and t19.bill_type = t17.dict_value         "
            + "   LEFT JOIN m_goods_unit_calc t18 ON t18.src_unit_id = t.unit_id and t18.sku_id = t.sku_id                                          "
            + "   LEFT JOIN m_cancel t20 ON t20.serial_id = t.id and t20.serial_type = '" + SystemConstants.SERIAL_TYPE.B_DELIVERY + "'                   "
            + "   LEFT JOIN v_dict_info t21 ON t21.code = '" + DictConstant.DICT_B_DELIVERY_TYPE + "' and t.type = t21.dict_value                         "
            + "   LEFT JOIN m_staff t26 ON t26.id = t.cancel_audit_id                                                                               "
            + "   ,(select @row_num:=0) t22                                                                                                         ";


    @Select("   <script> "
            + " ${p1.params.dataScopeAnnotation_with}                                                                                                                                                                "
            + "      SELECT                                                                                                                                                                                          "
            + "             t.*,                                                                                                                                                                                     "
            + "             t10.no,                                                                                                                                                                                  "
            + "             t13.order_id,                                                                                                                                                                            "
            + "             t.price*t.actual_count total_price,                                                                                                                                                      "
            + "             t13.primary_quantity,                                                                                                                                                                    "
            + "             t13.car_count,                                                                                                                                                                           "
            + "             ifnull(t19.order_no ,t25.order_no) order_no,                                                                                                                                             "
            + "             ifnull(t19.ship_name ,t25.ship_name) ship_name ,                                                                                                                                         "
            + "             ifnull(t19.contract_no ,t25.contract_no) contract_no ,                                                                                                                                   "
            + "             ifnull(t19.contract_dt ,t25.contract_dt) contract_dt ,                                                                                                                                   "
            + "             ifnull(t19.contract_num ,t25.contract_num) contract_num,                                                                                                                                 "
            + "             t13.pound_file ,                                                                                                                                                                         "
            + "             t13.photo_file ,                                                                                                                                                                         "
            + "             t13.inspection_file ,                                                                                                                                                                    "
            + "             t13.goods_file ,                                                                                                                                                                         "
            + "             t3.extra_code,                                                                                                                                                                           "
            + "             t3.waybill_code,                                                                                                                                                                         "
            + "             t3.code as plan_code,                                                                                                                                                                    "
            + "             t3.id as plan_id,                                                                                                                                                                        "
            + "             t10.code as plan_son_code,                                                                                                                                                               "
            + "             t15.label as status_name,                                                                                                                                                                "
            + "             ifnull(t16.label,t21.label) as type_name,                                                                                                                                                "
            + "             t17.label as bill_type_name,                                                                                                                                                             "
            + "             ifnull(t4.short_name,t4.name) as consignor_name,                                                                                                                                         "
            + "             ifnull(t5.short_name,t5.name) as owner_name,                                                                                                                                             "
            + "             ifnull(t6.short_name,t6.name) as customer_name,                                                                                                                                          "
            + "             t9.short_name as warehouse_name,                                                                                                                                                         "
            + "             t9.name as warehouse_full_name,                                                                                                                                                          "
            + "             t7.name as bin_name,                                                                                                                                                                     "
            + "             t8.name as location_name,                                                                                                                                                                "
            + "             t11.spec,                                                                                                                                                                                "
            + "             t11.pm,                                                                                                                                                                                  "
            + "             t12.name as goods_name,                                                                                                                                                                  "
            + "             t18.src_unit as unit_name,                                                                                                                                                               "
            + "             t1.name as c_name,                                                                                                                                                                       "
            + "             t14.name as e_name,                                                                                                                                                                      "
            + "             t2.name as u_name,                                                                                                                                                                       "
            + "             t23.id as monitor_in_id,                                                                                                                                                                 "
            + "             t20.remark as cancel_remark,                                                                                                                                                             "
            + "             t.cancel_audit_dt,                                                                                                                                                                       "
            + "             t26.name as cancel_audit_name                                                                                                                                                            "
            + "        FROM                                                                                                                                                                                          "
            + "         	b_delivery t                                                                                                                                                                                 "
            + "   LEFT JOIN m_staff t1 ON t.c_id = t1.id                                                                                                                                                             "
            + "   LEFT JOIN m_staff t2 ON t.u_id = t2.id                                                                                                                                                             "
            + "   LEFT JOIN m_staff t14 ON t.e_id = t14.id                                                                                                                                                           "
            + "   LEFT JOIN b_delivery_extra t13 ON t13.delivery_id = t.id                                                                                                                                                     "
            + "   LEFT JOIN b_in_plan_detail t10 ON t10.id = t.plan_detail_id                                                                                                                                        "
            + "   LEFT JOIN b_in_plan t3 ON t3.id = t.plan_id                                                                                                                                                        "
            + "   LEFT JOIN b_order t19 on t10.order_id = t19.serial_id and t10.order_type = t19.serial_type                                                                                                         "
            + "   LEFT JOIN b_order t25 on t13.order_id = t25.serial_id and t13.order_type = t25.serial_type                                                                                                         "
            + "   LEFT JOIN m_customer t4 ON t.consignor_id = t4.id                                                                                                                                                  "
            + "   LEFT JOIN m_owner t5 ON t.owner_id = t5.id                                                                                                                                                         "
            + "   LEFT JOIN m_customer t6 ON t19.customer_id = t6.id                                                                                                                                                 "
            + "   LEFT JOIN m_bin t7 ON t7.id = t.bin_id                                                                                                                                                             "
            + "   LEFT JOIN m_location t8 ON t8.id = t.location_id                                                                                                                                                   "
            + "   LEFT JOIN m_warehouse t9 ON t9.id = t.warehouse_id                                                                                                                                                 "
            + "   LEFT JOIN m_goods_spec t11 ON t11.id = t.sku_id                                                                                                                                                    "
            + "   LEFT JOIN m_goods_spec_prop t24 ON t11.prop_id = t24.id                                                                                                                                            "
            + "   LEFT JOIN m_goods t12 ON t12.id = t11.goods_id                                                                                                                                                     "
            + "   LEFT JOIN v_dict_info t15 ON t15.code = '" + DictConstant.DICT_B_DELIVERY_STATUS + "' and t.status = t15.dict_value                                                                                      "
            + "   LEFT JOIN v_dict_info t16 ON t16.code = '" + DictConstant.DICT_B_DELIVERY_TYPE + "' and t3.type = t16.dict_value                                                                                         "
            + "   LEFT JOIN v_dict_info t17 ON t17.code = '" + DictConstant.DICT_B_DELIVERY_BUSINESS_TYPE + "' and t19.bill_type = t17.dict_value                                                                          "
            + "   LEFT JOIN m_goods_unit_calc t18 ON t18.src_unit_id = t.unit_id and t18.sku_id = t.sku_id                                                                                                           "
            + "   LEFT JOIN m_cancel t20 ON t20.serial_id = t.id and t20.serial_type = '" + SystemConstants.SERIAL_TYPE.B_DELIVERY + "'                                                                                    "
            + "   LEFT JOIN v_dict_info t21 ON t21.code = '" + DictConstant.DICT_B_DELIVERY_TYPE + "' and t.type = t21.dict_value                                                                                          "
            + "   LEFT JOIN b_sync_status_error t22 ON t.sync_id = t22.id                                                                                                                                            "
            // 判断是否是监管任务生产的入库单, 如果是, 不能删除
            + "   left join b_monitor_in t23 ON t23.in_id = t.id                                                                                                                                                     "
            + "   LEFT JOIN m_staff t26 ON t26.id = t.cancel_audit_id                                                                                                                                                "
            + "   where true                                                                                                                                                                                         "
            + "      and (t.code like CONCAT ('%',#{p1.code,jdbcType=VARCHAR},'%') or #{p1.code,jdbcType=VARCHAR} is null or  #{p1.code,jdbcType=VARCHAR} ='')                                                       "
            + "      and (t3.code like CONCAT ('%',#{p1.plan_code,jdbcType=VARCHAR},'%') or #{p1.plan_code,jdbcType=VARCHAR} is null or #{p1.plan_code,jdbcType=VARCHAR} ='')                                        "
            + "      and (CONCAT(t5.name,t5.short_name,t5.name_pinyin,t5.short_name_pinyin) like CONCAT ('%',#{p1.owner_name,jdbcType=VARCHAR},'%') or #{p1.owner_name,jdbcType=VARCHAR} is null)                    "
            + "      and (CONCAT(t4.name,t4.short_name,t4.name_pinyin,t4.short_name_pinyin) like CONCAT ('%',#{p1.consignor_name,jdbcType=VARCHAR},'%') or #{p1.consignor_name,jdbcType=VARCHAR} is null)            "
            + "      and (t.warehouse_id = #{p1.warehouse_id,jdbcType=INTEGER} or #{p1.warehouse_id,jdbcType=INTEGER} is null)                                                                                       "
            + "      and (t.type = #{p1.type,jdbcType=VARCHAR} or #{p1.type,jdbcType=VARCHAR} is null or #{p1.type,jdbcType=VARCHAR} = '')                                                                           "
            + "      and (t13.bill_type = #{p1.bill_type,jdbcType=VARCHAR} or #{p1.bill_type,jdbcType=VARCHAR} is null or #{p1.bill_type,jdbcType=VARCHAR} ='')                                                      "
            + "      and (t.status = #{p1.status,jdbcType=VARCHAR} or #{p1.status,jdbcType=VARCHAR} is null or #{p1.status,jdbcType=VARCHAR} = '')                                                                   "
            + "      and (t12.name like CONCAT ('%',#{p1.goods_name,jdbcType=VARCHAR},'%')                                                                                                                           "
            + "           or t12.code like CONCAT ('%',#{p1.goods_name,jdbcType=VARCHAR},'%')                                                                                                                        "
            + "           or t11.spec like concat('%',#{p1.goods_name,jdbcType=VARCHAR},'%')                                                                                                                         "
            + "           or t.sku_code like concat('%',#{p1.goods_name,jdbcType=VARCHAR},'%')                                                                                                                       "
            + "           or #{p1.goods_name,jdbcType=VARCHAR} is null or #{p1.goods_name,jdbcType=VARCHAR} = '')                                                                                                    "
            + "      and (t19.contract_no like CONCAT ('%',#{p1.contract_no,jdbcType=VARCHAR},'%') or t25.contract_no like CONCAT ('%',#{p1.contract_no,jdbcType=VARCHAR},'%') or #{p1.contract_no,jdbcType=VARCHAR} is null)                                                                    "
            + "      and (t19.ship_name like CONCAT ('%',#{p1.ship_name,jdbcType=VARCHAR},'%') or t25.ship_name like CONCAT ('%',#{p1.ship_name,jdbcType=VARCHAR},'%') or #{p1.ship_name,jdbcType=VARCHAR} is null)                                                                          "
            + "      and (t19.customer_id = #{p1.customer_id,jdbcType=INTEGER} or t25.customer_id = #{p1.customer_id,jdbcType=INTEGER} or #{p1.customer_id,jdbcType=INTEGER} is null)                                                                                        "
            + "      and (CONCAT(ifnull(t6.name,''),ifnull(t6.short_name,''),ifnull(t6.name_pinyin,''),ifnull(t6.short_name_pinyin,'')) like CONCAT ('%',#{p1.customer_name,jdbcType=VARCHAR},'%') or #{p1.customer_name,jdbcType=VARCHAR} is null)              "
            + "      and (date_format(t.inbound_time, '%Y-%m-%d') &gt;= date_format(#{p1.start_time,jdbcType=DATE}, '%Y-%m-%d') or #{p1.start_time,jdbcType=DATE} is null)                                           "
            + "      and (date_format(t.inbound_time, '%Y-%m-%d') &lt;= date_format(#{p1.over_time,jdbcType=DATE}, '%Y-%m-%d') or #{p1.over_time,jdbcType=DATE} is null)                                             "
            + "      and (date_format(t.e_dt, '%Y-%m-%d') &gt;= #{p1.e_dt_start} or #{p1.e_dt_start} is null)                                                                                                        "
            + "      and (date_format(t.e_dt, '%Y-%m-%d') &lt;= #{p1.e_dt_end} or #{p1.e_dt_end} is null)                                                                                                            "
            + "      and (t24.name like concat('%', #{p1.prop}, '%') or #{p1.prop} is null or #{p1.prop} = '')                                                                                                       "
            + "      and (t3.waybill_code like concat('%', #{p1.waybill_code}, '%') or #{p1.waybill_code} is null or #{p1.waybill_code} = '')                                                                        "
            + "      and (t22.status = #{p1.sync_status} or #{p1.sync_status} is null or #{p1.sync_status} = '')                                                                                                     "
            + "      and (date_format(t.c_time, '%Y-%m-%d') &gt;= date_format(#{p1.c_time_start}, '%Y-%m-%d') or #{p1.c_time_start} is null)                                                                         "
            + "      and (date_format(t.c_time, '%Y-%m-%d') &lt;= date_format(#{p1.c_time_end}, '%Y-%m-%d') or #{p1.c_time_end} is null)                                                                             "
            + "      and (t.vehicle_no like concat('%', #{p1.vehicle_no}, '%') or #{p1.vehicle_no} is null or #{p1.vehicle_no} = '')                                                                                 "
            + "      and (DATE_FORMAT(t.c_time, '%Y-%m-%d' ) &gt;= #{p1.batch} or #{p1.batch} is null or #{p1.batch} = '')                                                                                           "
            + "   <if test='p1.type_list != null and p1.type_list.length!=0' >                                                                                                                                       "
            + "    and t.type in                                                                                                                                                                                     "
            + "        <foreach collection='p1.type_list' item='item' index='index' open='(' separator=',' close=')'>                                                                                                "
            + "         #{item}                                                                                                                                                                                      "
            + "        </foreach>                                                                                                                                                                                    "
            + "   </if>                                                                                                                                                                                              "
            + "   <if test='p1.status_list != null and p1.status_list.length!=0' >                                                                                                                                   "
            + "    and t.status in                                                                                                                                                                                   "
            + "        <foreach collection='p1.status_list' item='item' index='index' open='(' separator=',' close=')'>                                                                                              "
            + "         #{item}                                                                                                                                                                                      "
            + "        </foreach>                                                                                                                                                                                    "
            + "   </if>                                                                                                                                                                                              "
            + "      and (t9.warehouse_type = #{p1.warehouse_type} or #{p1.warehouse_type} is null or  #{p1.warehouse_type} = '')                                                                                    "
            //注意 exists里面使用count(1)需要配合分组使用 or 返回 IF(count( 1 )<1,NULL,true)
            + "    <if test='p1.todo_status == 0' >                                                                                                                                                             "
            + "  and exists (                                                                                                                                                                                   "
            + "		SELECT                                                                                                                                                                                      "
            + "				count(1)                                                                                                                                                                                   "
            + "			FROM                                                                                                                                                                                    "
            + "				b_todo subt1                                                                                                                                                                        "
            + "				INNER JOIN v_permission_operation_all subt2 ON subt2.staff_id = #{p1.staff_id,jdbcType=INTEGER}                                                                                     "
            + "				AND subt1.position_id = subt2.position_id                                                                                                                                           "
            + "				AND subt2.operation_perms = subt1.perms                                                                                                                                             "
            + "			WHERE                                                                                                                                                                                   "
            + "				t.id = subt1.serial_id                                                                                                                                                              "
            + "				AND subt1.serial_type = '" + SystemConstants.SERIAL_TYPE.B_DELIVERY + "'                                                                                                                     "
            + "				AND subt1.STATUS = '" + DictConstant.DICT_B_TODO_STATUS_TODO + "'                                                                                                                      "
            + "				GROUP BY subt1.serial_id, subt1.serial_type                                                                                                                                         "
            + "  )                                                                                                                                                                                              "
            + "      </if>                                                                                                                                                                                      "

            // 已办
            + "      <if test='p1.todo_status == 1' >                                                                                                                                                           "
            + "      and exists (                                                                                                                                                                               "
            + "             select count(1)                                                                                                                                                                           "
            + "               from b_already_do subt1                                                                                                                                                           "
            + "              where subt1.serial_type = '" + SystemConstants.SERIAL_TYPE.B_DELIVERY + "'                                                                                                               "
            + "                and subt1.staff_id = #{p1.staff_id,jdbcType=INTEGER}                                                                                                                             "
            + "                and serial_id = t.id                                                                                                                                                             "
            + "				GROUP BY subt1.serial_id, subt1.serial_type                                                                                                                                         "
            + "       )                                                                                                                                                                                         "
            + "      </if>                                                                                                                                                                                      "

            // 仓库权限
            + "     ${p1.params.dataScopeAnnotation}                                                                                                                                                                 "
            + "    ORDER BY ${p2} ${p3} ${p4}                                                                                                                                                                        "
            + "    limit ${(p1.pageCondition.current-1)*p1.pageCondition.size},  #{p1.pageCondition.size}                                                                                                            "
            + "      </script> ")
    List<BDeliveryVo> selectPageListNotCount(@Param("p1") BDeliveryVo searchCondition, @Param("p2") String sort, @Param("p3") String sortType, @Param("p4") String defaultSort);


    @Select("   <script> "
            + " ${p1.params.dataScopeAnnotation_with}                                                                                                                                                                "
            + "      SELECT                                                                                                                                                                                          "
            + "             count(1) c                                                                                                                                                                                       "
            + "        FROM                                                                                                                                                                                         "
            + "         	b_delivery t                                                                                                                                                                                 "
            + "   LEFT JOIN m_staff t1 ON t.c_id = t1.id                                                                                                                                                                            "
            + "   LEFT JOIN m_staff t2 ON t.u_id = t2.id                                                                                                                                                                            "
            + "   LEFT JOIN m_staff t14 ON t.e_id = t14.id                                                                                                                                                                          "
            + "   LEFT JOIN b_delivery_extra t13 ON t13.delivery_id = t.id                                                                                                                                                                     "
            + "   LEFT JOIN b_in_plan_detail t10 ON t10.id = t.plan_detail_id                                                                                                                                                       "
            + "   LEFT JOIN b_in_plan t3 ON t3.id = t.plan_id                                                                                                                                                                       "
            + "   LEFT JOIN b_order t19 on t10.order_id = t19.serial_id and t10.order_type = t19.serial_type                                                                                                                        "
            + "   LEFT JOIN b_order t25 on t13.order_id = t25.serial_id and t13.order_type = t25.serial_type                                                                                                                        "
            + "   LEFT JOIN m_customer t4 ON t.consignor_id = t4.id                                                                                                                                                                 "
            + "   LEFT JOIN m_owner t5 ON t.owner_id = t5.id                                                                                                                                                                        "
            + "   LEFT JOIN m_customer t6 ON t19.customer_id = t6.id                                                                                                                                                                "
            + "   LEFT JOIN m_bin t7 ON t7.id = t.bin_id                                                                                                                                                                            "
            + "   LEFT JOIN m_location t8 ON t8.id = t.location_id                                                                                                                                                                  "
            + "   LEFT JOIN m_warehouse t9 ON t9.id = t.warehouse_id                                                                                                                                                                "
            + "   LEFT JOIN m_goods_spec t11 ON t11.id = t.sku_id                                                                                                                                                                   "
            + "   LEFT JOIN m_goods_spec_prop t24 ON t11.prop_id = t24.id                                                                                                                                                           "
            + "   LEFT JOIN m_goods t12 ON t12.id = t11.goods_id                                                                                                                                                                    "
            + "   LEFT JOIN b_sync_status_error t22 ON t.sync_id = t22.id                                                                                     "
            + "   where true                                                                                                                                                                                         "
            + "      and (t.code like CONCAT ('%',#{p1.code,jdbcType=VARCHAR},'%') or #{p1.code,jdbcType=VARCHAR} is null or  #{p1.code,jdbcType=VARCHAR} ='')                                                       "
            + "      and (t3.code like CONCAT ('%',#{p1.plan_code,jdbcType=VARCHAR},'%') or #{p1.plan_code,jdbcType=VARCHAR} is null or #{p1.plan_code,jdbcType=VARCHAR} ='')                                        "
            + "      and (CONCAT(t5.name,t5.short_name,t5.name_pinyin,t5.short_name_pinyin) like CONCAT ('%',#{p1.owner_name,jdbcType=VARCHAR},'%') or #{p1.owner_name,jdbcType=VARCHAR} is null)                    "
            + "      and (CONCAT(t4.name,t4.short_name,t4.name_pinyin,t4.short_name_pinyin) like CONCAT ('%',#{p1.consignor_name,jdbcType=VARCHAR},'%') or #{p1.consignor_name,jdbcType=VARCHAR} is null)            "
            + "      and (t.warehouse_id = #{p1.warehouse_id,jdbcType=INTEGER} or #{p1.warehouse_id,jdbcType=INTEGER} is null)                                                                                       "
            + "      and (t.type = #{p1.type,jdbcType=VARCHAR} or #{p1.type,jdbcType=VARCHAR} is null or #{p1.type,jdbcType=VARCHAR} = '')                                                                           "
            + "      and (t13.bill_type = #{p1.bill_type,jdbcType=VARCHAR} or #{p1.bill_type,jdbcType=VARCHAR} is null or #{p1.bill_type,jdbcType=VARCHAR} ='')                                                      "
            + "      and (t.status = #{p1.status,jdbcType=VARCHAR} or #{p1.status,jdbcType=VARCHAR} is null or #{p1.status,jdbcType=VARCHAR} = '')                                                                   "
            + "      and (t12.name like CONCAT ('%',#{p1.goods_name,jdbcType=VARCHAR},'%')                                                                                                                           "
            + "           or t12.code like CONCAT ('%',#{p1.goods_name,jdbcType=VARCHAR},'%')                                                                                                                        "
            + "           or t11.spec like concat('%',#{p1.goods_name,jdbcType=VARCHAR},'%')                                                                                                                         "
            + "           or t.sku_code like concat('%',#{p1.goods_name,jdbcType=VARCHAR},'%')                                                                                                                       "
            + "           or #{p1.goods_name,jdbcType=VARCHAR} is null or #{p1.goods_name,jdbcType=VARCHAR} = '')                                                                                                    "
            + "      and (t19.contract_no like CONCAT ('%',#{p1.contract_no,jdbcType=VARCHAR},'%') or t25.contract_no like CONCAT ('%',#{p1.contract_no,jdbcType=VARCHAR},'%') or #{p1.contract_no,jdbcType=VARCHAR} is null)                                                                    "
            + "      and (t19.ship_name like CONCAT ('%',#{p1.ship_name,jdbcType=VARCHAR},'%')  or t25.ship_name like CONCAT ('%',#{p1.ship_name,jdbcType=VARCHAR},'%')  or #{p1.ship_name,jdbcType=VARCHAR} is null) "
            + "      and (t19.customer_id = #{p1.customer_id,jdbcType=INTEGER} or t25.customer_id = #{p1.customer_id,jdbcType=INTEGER}  or #{p1.customer_id,jdbcType=INTEGER} is null)                               "
            + "      and (CONCAT(ifnull(t6.name,''),ifnull(t6.short_name,''),ifnull(t6.name_pinyin,''),ifnull(t6.short_name_pinyin,'')) like CONCAT ('%',#{p1.customer_name,jdbcType=VARCHAR},'%') or #{p1.customer_name,jdbcType=VARCHAR} is null)"
            + "      and (date_format(t.inbound_time, '%Y-%m-%d') &gt;= date_format(#{p1.start_time,jdbcType=DATE}, '%Y-%m-%d') or #{p1.start_time,jdbcType=DATE} is null)                                           "
            + "      and (date_format(t.inbound_time, '%Y-%m-%d') &lt;= date_format(#{p1.over_time,jdbcType=DATE}, '%Y-%m-%d') or #{p1.over_time,jdbcType=DATE} is null)                                             "
            + "      and (date_format(t.e_dt, '%Y-%m-%d') &gt;= #{p1.e_dt_start} or #{p1.e_dt_start} is null)                                                                                                        "
            + "      and (date_format(t.e_dt, '%Y-%m-%d') &lt;= #{p1.e_dt_end} or #{p1.e_dt_end} is null)                                                                                                            "
            + "      and (t24.name like concat('%', #{p1.prop}, '%') or #{p1.prop} is null or #{p1.prop} = '')                                                                                                       "
            + "      and (t3.waybill_code like concat('%', #{p1.waybill_code}, '%') or #{p1.waybill_code} is null or #{p1.waybill_code} = '') "
            + "      and (t22.status = #{p1.sync_status} or #{p1.sync_status} is null or #{p1.sync_status} = '')                                                    "
            + "      and (date_format(t.c_time, '%Y-%m-%d') &gt;= date_format(#{p1.c_time_start}, '%Y-%m-%d') or #{p1.c_time_start} is null)                                                                         "
            + "      and (date_format(t.c_time, '%Y-%m-%d') &lt;= date_format(#{p1.c_time_end}, '%Y-%m-%d') or #{p1.c_time_end} is null)                                                                             "
            + "      and (DATE_FORMAT(t.c_time, '%Y-%m-%d' ) &gt;= #{p1.batch} or #{p1.batch} is null or #{p1.batch} = '')                                                           "
            + "   <if test='p1.type_list != null and p1.type_list.length!=0' >                                                                                              "
            + "    and t.type in                                                                                                                                              "
            + "        <foreach collection='p1.type_list' item='item' index='index' open='(' separator=',' close=')'>                                                         "
            + "         #{item}                                                                                                                                                 "
            + "        </foreach>                                                                                                                                               "
            + "   </if>                                                                                                                                                         "
            + "   <if test='p1.status_list != null and p1.status_list.length!=0' >                                                                                              "
            + "    and t.status in                                                                                                                                              "
            + "        <foreach collection='p1.status_list' item='item' index='index' open='(' separator=',' close=')'>                                                         "
            + "         #{item}                                                                                                                                                 "
            + "        </foreach>                                                                                                                                               "
            + "   </if>                                                                                                                                                         "
            + "      and (t.vehicle_no like concat('%', #{p1.vehicle_no}, '%') or #{p1.vehicle_no} is null or #{p1.vehicle_no} = '')                                            "
            + "      and (t9.warehouse_type = #{p1.warehouse_type} or #{p1.warehouse_type} is null or  #{p1.warehouse_type} = '')                                               "

            //注意 exists里面使用count(1)需要配合分组使用 or 返回 IF(count( 1 )<1,NULL,true)
            + "    <if test='p1.todo_status == 0' >                                                                                                                                                             "
            + "  and exists (                                                                                                                                                                                   "
            + "		SELECT                                                                                                                                                                                      "
            + "				count(1)                                                                                                                                                                                   "
            + "			FROM                                                                                                                                                                                    "
            + "				b_todo subt1                                                                                                                                                                        "
            + "				INNER JOIN v_permission_operation_all subt2 ON subt2.staff_id = #{p1.staff_id,jdbcType=INTEGER}                                                                                     "
            + "				AND subt1.position_id = subt2.position_id                                                                                                                                           "
            + "				AND subt2.operation_perms = subt1.perms                                                                                                                                             "
            + "			WHERE                                                                                                                                                                                   "
            + "				t.id = subt1.serial_id                                                                                                                                                              "
            + "				AND subt1.serial_type = '" + SystemConstants.SERIAL_TYPE.B_DELIVERY + "'                                                                                                                     "
            + "				AND subt1.STATUS = '" + DictConstant.DICT_B_TODO_STATUS_TODO + "'                                                                                                                      "
            + "				GROUP BY subt1.serial_id, subt1.serial_type                                                                                                                                         "
            + "  )                                                                                                                                                                                              "
            + "      </if>                                                                                                                                                                                      "

            // 已办
            + "      <if test='p1.todo_status == 1' >                                                                                                                                                           "
            + "      and exists (                                                                                                                                                                               "
            + "             select count(1)                                                                                                                                                                           "
            + "               from b_already_do subt1                                                                                                                                                           "
            + "              where subt1.serial_type = '" + SystemConstants.SERIAL_TYPE.B_DELIVERY + "'                                                                                                               "
            + "                and subt1.staff_id = #{p1.staff_id,jdbcType=INTEGER}                                                                                                                             "
            + "                and serial_id = t.id                                                                                                                                                             "
            + "				GROUP BY subt1.serial_id, subt1.serial_type                                                                                                                                         "
            + "       )                                                                                                                                                                                         "
            + "      </if>                                                                                                                                                                                      "

            // 仓库权限
            + "     ${p1.params.dataScopeAnnotation}                                                                                                                            "
            + "      </script> ")
    Long selectPageMyCount(@Param("p1") BDeliveryVo searchCondition);

    /**
     * 页面查询列表
     *
     * @param page
     * @param searchCondition
     * @return
     */
    @Select("   <script> "
            + " ${p1.params.dataScopeAnnotation_with}                                                                                               "
            + "      SELECT                                                                                                                                                                                                         "
            + "             count(t.id) c                                                                                                                                                                             "
            + "        FROM                                                                                                                                                                                                         "
            + "               b_delivery t                                                                                                                                                             "
            + "   LEFT JOIN m_staff t1 ON t.c_id = t1.id                                                                                                                                                                            "
            + "   LEFT JOIN m_staff t2 ON t.u_id = t2.id                                                                                                                                                                            "
            + "   LEFT JOIN m_staff t14 ON t.e_id = t14.id                                                                                                                                                                          "
            + "   LEFT JOIN b_delivery_extra t13 ON t13.delivery_id = t.id                                                                                                                                                                "
            + "   LEFT JOIN b_in_plan_detail t10 ON t10.id = t.plan_detail_id                                                                                                                                                       "
            + "   LEFT JOIN b_in_plan t3 ON t3.id = t.plan_id                                                                                                                                                                       "
            + "   LEFT JOIN b_order t19 on t13.order_id = t19.serial_id and t13.order_type = t19.serial_type                                                                                                                        "
            + "   LEFT JOIN m_customer t4 ON t.consignor_id = t4.id                                                                                                                                                                 "
            + "   LEFT JOIN m_owner t5 ON t.owner_id = t5.id                                                                                                                                                                        "
            + "   LEFT JOIN m_customer t6 ON t19.customer_id = t6.id                                                                                                                                                                "
            + "   LEFT JOIN m_bin t7 ON t7.id = t.bin_id                                                                                                                                                                            "
            + "   LEFT JOIN m_location t8 ON t8.id = t.location_id                                                                                                                                                                  "
            + "   LEFT JOIN m_warehouse t9 ON t9.id = t.warehouse_id                                                                                                                                                                "
            + "   LEFT JOIN m_goods_spec t11 ON t11.id = t.sku_id                                                                                                                                                                   "
            + "   LEFT JOIN m_goods_spec_prop t24 ON t11.prop_id = t24.id                                                                                                                                                           "
            + "   LEFT JOIN m_goods t12 ON t12.id = t11.goods_id                                                                                                                                                                    "
            + "   LEFT JOIN v_dict_info t15 ON t15.code = '" + DictConstant.DICT_B_DELIVERY_STATUS + "' and t.status = t15.dict_value                                                                                                         "
            + "   LEFT JOIN v_dict_info t16 ON t16.code = '" + DictConstant.DICT_B_DELIVERY_TYPE + "' and t3.type = t16.dict_value                                                                                                            "
            + "   LEFT JOIN v_dict_info t17 ON t17.code = '" + DictConstant.DICT_B_DELIVERY_BUSINESS_TYPE + "' and t19.bill_type = t17.dict_value                                                                                             "
            + "   LEFT JOIN m_goods_unit_calc t18 ON t18.src_unit_id = t.unit_id and t18.sku_id = t.sku_id                                                                                                                          "
            + "   LEFT JOIN m_cancel t20 ON t20.serial_id = t.id and t20.serial_type = '" + SystemConstants.SERIAL_TYPE.B_DELIVERY + "'                                                                                                     "
            + "   LEFT JOIN v_dict_info t21 ON t21.code = '" + DictConstant.DICT_B_DELIVERY_TYPE + "' and t.type = t21.dict_value                                                                                                             "
            + "   LEFT JOIN b_sync_status_error t22 ON t.sync_id = t22.id                                                                                     "
//            + "   ,(select @row_num:=0) t22                                                                                                                                                                                         "
            + "   where true                                                                                                                                                                                         "
            + "      and (t.code like CONCAT ('%',#{p1.code,jdbcType=VARCHAR},'%') or #{p1.code,jdbcType=VARCHAR} is null or  #{p1.code,jdbcType=VARCHAR} ='')                                                       "
            + "      and (t3.code like CONCAT ('%',#{p1.plan_code,jdbcType=VARCHAR},'%') or #{p1.plan_code,jdbcType=VARCHAR} is null or #{p1.plan_code,jdbcType=VARCHAR} ='')                                        "
            + "      and (CONCAT(t5.name,t5.short_name,t5.name_pinyin,t5.short_name_pinyin) like CONCAT ('%',#{p1.owner_name,jdbcType=VARCHAR},'%') or #{p1.owner_name,jdbcType=VARCHAR} is null)                    "
            + "      and (CONCAT(t4.name,t4.short_name,t4.name_pinyin,t4.short_name_pinyin) like CONCAT ('%',#{p1.consignor_name,jdbcType=VARCHAR},'%') or #{p1.consignor_name,jdbcType=VARCHAR} is null)            "
            + "      and (t.warehouse_id = #{p1.warehouse_id,jdbcType=INTEGER} or #{p1.warehouse_id,jdbcType=INTEGER} is null)                                                                                       "
            + "      and (t.type = #{p1.type,jdbcType=VARCHAR} or #{p1.type,jdbcType=VARCHAR} is null or #{p1.type,jdbcType=VARCHAR} = '')                                                                           "
            + "      and (t13.bill_type = #{p1.bill_type,jdbcType=VARCHAR} or #{p1.bill_type,jdbcType=VARCHAR} is null or #{p1.bill_type,jdbcType=VARCHAR} ='')                                                      "
            + "      and (t.status = #{p1.status,jdbcType=VARCHAR} or #{p1.status,jdbcType=VARCHAR} is null or #{p1.status,jdbcType=VARCHAR} = '')                                                                   "
            + "      and (t12.name like CONCAT ('%',#{p1.goods_name,jdbcType=VARCHAR},'%')                                                                                                                           "
            + "           or t12.code like CONCAT ('%',#{p1.goods_name,jdbcType=VARCHAR},'%')                                                                                                                        "
            + "           or t11.spec like concat('%',#{p1.goods_name,jdbcType=VARCHAR},'%')                                                                                                                         "
            + "           or t.sku_code like concat('%',#{p1.goods_name,jdbcType=VARCHAR},'%')                                                                                                                       "
            + "           or #{p1.goods_name,jdbcType=VARCHAR} is null or #{p1.goods_name,jdbcType=VARCHAR} = '')                                                                                                                                              "
            + "      and (t19.contract_no like CONCAT ('%',#{p1.contract_no,jdbcType=VARCHAR},'%') or #{p1.contract_no,jdbcType=VARCHAR} is null)                                                                    "
            + "      and (t19.ship_name like CONCAT ('%',#{p1.ship_name,jdbcType=VARCHAR},'%') or #{p1.ship_name,jdbcType=VARCHAR} is null)                                                                          "
            + "      and (t19.customer_id = #{p1.customer_id,jdbcType=INTEGER} or #{p1.customer_id,jdbcType=INTEGER} is null)                                                                                        "
            + "      and (CONCAT(ifnull(t6.name,''),ifnull(t6.short_name,''),ifnull(t6.name_pinyin,''),ifnull(t6.short_name_pinyin,'')) like CONCAT ('%',#{p1.customer_name,jdbcType=VARCHAR},'%') or #{p1.customer_name,jdbcType=VARCHAR} is null)              "
            + "      and (date_format(t.inbound_time, '%Y-%m-%d') &gt;= date_format(#{p1.start_time,jdbcType=DATE}, '%Y-%m-%d') or #{p1.start_time,jdbcType=DATE} is null)                                           "
            + "      and (date_format(t.inbound_time, '%Y-%m-%d') &lt;= date_format(#{p1.over_time,jdbcType=DATE}, '%Y-%m-%d') or #{p1.over_time,jdbcType=DATE} is null)                                             "
            + "      and (date_format(t.e_dt, '%Y-%m-%d') &gt;= #{p1.e_dt_start} or #{p1.e_dt_start} is null)                                                                                                        "
            + "      and (date_format(t.e_dt, '%Y-%m-%d') &lt;= #{p1.e_dt_end} or #{p1.e_dt_end} is null)                                                                                                            "
            + "      and (t24.name like concat('%', #{p1.prop}, '%') or #{p1.prop} is null or #{p1.prop} = '')                                                                                                       "
            + "      and (t3.waybill_code like concat('%', #{p1.waybill_code}, '%') or #{p1.waybill_code} is null or #{p1.waybill_code} = '') "
            + "      and (t22.status = #{p1.sync_status} or #{p1.sync_status} is null or #{p1.sync_status} = '')                                                    "
            + "      and (date_format(t.c_time, '%Y-%m-%d') &gt;= date_format(#{p1.c_time_start}, '%Y-%m-%d') or #{p1.c_time_start} is null)                                                                         "
            + "      and (date_format(t.c_time, '%Y-%m-%d') &lt;= date_format(#{p1.c_time_end}, '%Y-%m-%d') or #{p1.c_time_end} is null)                                                                             "
            + "      and (t.vehicle_no like concat('%', #{p1.vehicle_no}, '%') or #{p1.vehicle_no} is null or #{p1.vehicle_no} = '')                                            "
            + "      and (DATE_FORMAT(t.c_time, '%Y-%m-%d' ) &gt;= #{p1.batch} or #{p1.batch} is null or #{p1.batch} = '')                                                           "
            + "   <if test='p1.type_list != null and p1.type_list.length!=0' >                                                                                              "
            + "    and t.type in                                                                                                                                              "
            + "        <foreach collection='p1.type_list' item='item' index='index' open='(' separator=',' close=')'>                                                         "
            + "         #{item}                                                                                                                                                 "
            + "        </foreach>                                                                                                                                               "
            + "   </if>                                                                                                                                                         "

            + "   <if test='p1.status_list != null and p1.status_list.length!=0' >                                                                                              "
            + "    and t.status in                                                                                                                                              "
            + "        <foreach collection='p1.status_list' item='item' index='index' open='(' separator=',' close=')'>                                                         "
            + "         #{item}                                                                                                                                                 "
            + "        </foreach>                                                                                                                                               "
            + "   </if>                                                                                                                                                         "
            + "      and (t9.warehouse_type = #{p1.warehouse_type} or #{p1.warehouse_type} is null or  #{p1.warehouse_type} = '')                                               "
            //注意 exists里面使用count(1)需要配合分组使用 or 返回 IF(count( 1 )<1,NULL,true)
            + "  and exists (                                                                                                                                                                                   "
            + "		SELECT                                                                                                                                                                                      "
            + "				count(1)                                                                                                                                                                                   "
            + "			FROM                                                                                                                                                                                    "
            + "				b_todo subt1                                                                                                                                                                        "
            + "				INNER JOIN v_permission_operation_all subt2 ON subt2.staff_id = #{p1.staff_id,jdbcType=INTEGER}                                                                                     "
            + "				AND subt1.position_id = subt2.position_id                                                                                                                                           "
            + "				AND subt2.operation_perms = subt1.perms                                                                                                                                             "
            + "			WHERE                                                                                                                                                                                   "
            + "				t.id = subt1.serial_id                                                                                                                                                              "
            + "				AND subt1.serial_type = '" + SystemConstants.SERIAL_TYPE.B_DELIVERY + "'                                                                                                                     "
            + "				AND subt1.STATUS = '" + DictConstant.DICT_B_TODO_STATUS_TODO + "'                                                                                                                      "
            + "				GROUP BY subt1.serial_id, subt1.serial_type                                                                                                                                         "
            + "  )                                                                                                                                                                                              "

            // 仓库权限
            + "     ${p1.params.dataScopeAnnotation}                                                                                                                                                                                "
            + "      </script> ")
    Integer selectTodoCount(@Param("p1") BDeliveryVo searchCondition);

    @Select("   <script> "
            + " ${p1.params.dataScopeAnnotation_with}                                                                                                                                                                "
            + "      SELECT                                                                                                                                                                                          "
            + "             sum(t.actual_count) actual_count,                                                                                       "
            + "             sum(t.amount) amount                                                                                                   "
            + "        FROM                                                                                                                                                                                          "
            + "         	  b_delivery t                                                                                                                                                                                 "
            + "   LEFT JOIN m_staff t1 ON t.c_id = t1.id                                                                                                                                                             "
            + "   LEFT JOIN m_staff t2 ON t.u_id = t2.id                                                                                                                                                             "
            + "   LEFT JOIN m_staff t14 ON t.e_id = t14.id                                                                                                                                                           "
            + "   LEFT JOIN b_delivery_extra t13 ON t13.delivery_id = t.id                                                                                                                                                   "
            + "   LEFT JOIN b_in_plan_detail t10 ON t10.id = t.plan_detail_id                                                                                                                                        "
            + "   LEFT JOIN b_in_plan t3 ON t3.id = t.plan_id                                                                                                                                                        "
            + "   LEFT JOIN b_order t19 on t10.order_id = t19.serial_id and t10.order_type = t19.serial_type                                                                                                         "
            + "   LEFT JOIN b_order t25 on t13.order_id = t25.serial_id and t13.order_type = t25.serial_type                                                                                                         "
            + "   LEFT JOIN m_customer t4 ON t.consignor_id = t4.id                                                                                                                                                  "
            + "   LEFT JOIN m_owner t5 ON t.owner_id = t5.id                                                                                                                                                         "
            + "   LEFT JOIN m_customer t6 ON t19.customer_id = t6.id                                                                                                                                                 "
            + "   LEFT JOIN m_bin t7 ON t7.id = t.bin_id                                                                                                                                                             "
            + "   LEFT JOIN m_location t8 ON t8.id = t.location_id                                                                                                                                                   "
            + "   LEFT JOIN m_warehouse t9 ON t9.id = t.warehouse_id                                                                                                                                                 "
            + "   LEFT JOIN m_goods_spec t11 ON t11.id = t.sku_id                                                                                                                                                    "
            + "   LEFT JOIN m_goods_spec_prop t24 ON t11.prop_id = t24.id                                                                                                                                            "
            + "   LEFT JOIN m_goods t12 ON t12.id = t11.goods_id                                                                                                                                                     "
            + "   LEFT JOIN v_dict_info t15 ON t15.code = '" + DictConstant.DICT_B_DELIVERY_STATUS + "' and t.status = t15.dict_value                                                                                      "
            + "   LEFT JOIN v_dict_info t16 ON t16.code = '" + DictConstant.DICT_B_DELIVERY_TYPE + "' and t3.type = t16.dict_value                                                                                         "
            + "   LEFT JOIN v_dict_info t17 ON t17.code = '" + DictConstant.DICT_B_DELIVERY_BUSINESS_TYPE + "' and t19.bill_type = t17.dict_value                                                                          "
            + "   LEFT JOIN m_goods_unit_calc t18 ON t18.src_unit_id = t.unit_id and t18.sku_id = t.sku_id                                                                                                           "
            + "   LEFT JOIN m_cancel t20 ON t20.serial_id = t.id and t20.serial_type = '" + SystemConstants.SERIAL_TYPE.B_DELIVERY + "'                                                                                    "
            + "   LEFT JOIN v_dict_info t21 ON t21.code = '" + DictConstant.DICT_B_DELIVERY_TYPE + "' and t.type = t21.dict_value                                                                                          "
            + "   LEFT JOIN b_sync_status_error t22 ON t.sync_id = t22.id                                                                                                                                            "
            // 判断是否是监管任务生产的入库单, 如果是, 不能删除
            + "   left join b_monitor_in t23 ON t23.in_id = t.id                                                                                                                                                     "
            + "   LEFT JOIN m_staff t26 ON t26.id = t.cancel_audit_id                                                                                                                                                "
            + "   where true                                                                                                                                                                                         "
            + "      and (t.code like CONCAT ('%',#{p1.code,jdbcType=VARCHAR},'%') or #{p1.code,jdbcType=VARCHAR} is null or  #{p1.code,jdbcType=VARCHAR} ='')                                                       "
            + "      and (t3.code like CONCAT ('%',#{p1.plan_code,jdbcType=VARCHAR},'%') or #{p1.plan_code,jdbcType=VARCHAR} is null or #{p1.plan_code,jdbcType=VARCHAR} ='')                                        "
            + "      and (CONCAT(t5.name,t5.short_name,t5.name_pinyin,t5.short_name_pinyin) like CONCAT ('%',#{p1.owner_name,jdbcType=VARCHAR},'%') or #{p1.owner_name,jdbcType=VARCHAR} is null)                    "
            + "      and (CONCAT(t4.name,t4.short_name,t4.name_pinyin,t4.short_name_pinyin) like CONCAT ('%',#{p1.consignor_name,jdbcType=VARCHAR},'%') or #{p1.consignor_name,jdbcType=VARCHAR} is null)            "
            + "      and (t.warehouse_id = #{p1.warehouse_id,jdbcType=INTEGER} or #{p1.warehouse_id,jdbcType=INTEGER} is null)                                                                                       "
            + "      and (t.type = #{p1.type,jdbcType=VARCHAR} or #{p1.type,jdbcType=VARCHAR} is null or #{p1.type,jdbcType=VARCHAR} = '')                                                                           "
            + "      and (t13.bill_type = #{p1.bill_type,jdbcType=VARCHAR} or #{p1.bill_type,jdbcType=VARCHAR} is null or #{p1.bill_type,jdbcType=VARCHAR} ='')                                                      "
            + "      and (t.status = #{p1.status,jdbcType=VARCHAR} or #{p1.status,jdbcType=VARCHAR} is null or #{p1.status,jdbcType=VARCHAR} = '')                                                                   "
            + "      and (t12.name like CONCAT ('%',#{p1.goods_name,jdbcType=VARCHAR},'%')                                                                                                                           "
            + "           or t12.code like CONCAT ('%',#{p1.goods_name,jdbcType=VARCHAR},'%')                                                                                                                        "
            + "           or t11.spec like concat('%',#{p1.goods_name,jdbcType=VARCHAR},'%')                                                                                                                         "
            + "           or t.sku_code like concat('%',#{p1.goods_name,jdbcType=VARCHAR},'%')                                                                                                                       "
            + "           or #{p1.goods_name,jdbcType=VARCHAR} is null or #{p1.goods_name,jdbcType=VARCHAR} = '')                                                                                                    "
            + "      and (t19.contract_no like CONCAT ('%',#{p1.contract_no,jdbcType=VARCHAR},'%') or t25.contract_no like CONCAT ('%',#{p1.contract_no,jdbcType=VARCHAR},'%') or #{p1.contract_no,jdbcType=VARCHAR} is null)                                                                    "
            + "      and (t19.ship_name like CONCAT ('%',#{p1.ship_name,jdbcType=VARCHAR},'%') or t25.ship_name like CONCAT ('%',#{p1.ship_name,jdbcType=VARCHAR},'%') or #{p1.ship_name,jdbcType=VARCHAR} is null)                                                                          "
            + "      and (t19.customer_id = #{p1.customer_id,jdbcType=INTEGER} or t25.customer_id = #{p1.customer_id,jdbcType=INTEGER} or #{p1.customer_id,jdbcType=INTEGER} is null)                                                                                        "
            + "      and (CONCAT(ifnull(t6.name,''),ifnull(t6.short_name,''),ifnull(t6.name_pinyin,''),ifnull(t6.short_name_pinyin,'')) like CONCAT ('%',#{p1.customer_name,jdbcType=VARCHAR},'%') or #{p1.customer_name,jdbcType=VARCHAR} is null)              "
            + "      and (date_format(t.inbound_time, '%Y-%m-%d') &gt;= date_format(#{p1.start_time,jdbcType=DATE}, '%Y-%m-%d') or #{p1.start_time,jdbcType=DATE} is null)                                           "
            + "      and (date_format(t.inbound_time, '%Y-%m-%d') &lt;= date_format(#{p1.over_time,jdbcType=DATE}, '%Y-%m-%d') or #{p1.over_time,jdbcType=DATE} is null)                                             "
            + "      and (date_format(t.e_dt, '%Y-%m-%d') &gt;= #{p1.e_dt_start} or #{p1.e_dt_start} is null)                                                                                                        "
            + "      and (date_format(t.e_dt, '%Y-%m-%d') &lt;= #{p1.e_dt_end} or #{p1.e_dt_end} is null)                                                                                                            "
            + "      and (t24.name like concat('%', #{p1.prop}, '%') or #{p1.prop} is null or #{p1.prop} = '')                                                                                                       "
            + "      and (t3.waybill_code like concat('%', #{p1.waybill_code}, '%') or #{p1.waybill_code} is null or #{p1.waybill_code} = '')                                                                        "
            + "      and (t22.status = #{p1.sync_status} or #{p1.sync_status} is null or #{p1.sync_status} = '')                                                                                                     "
            + "      and (date_format(t.c_time, '%Y-%m-%d') &gt;= date_format(#{p1.c_time_start}, '%Y-%m-%d') or #{p1.c_time_start} is null)                                                                         "
            + "      and (date_format(t.c_time, '%Y-%m-%d') &lt;= date_format(#{p1.c_time_end}, '%Y-%m-%d') or #{p1.c_time_end} is null)                                                                             "
            + "      and (t.vehicle_no like concat('%', #{p1.vehicle_no}, '%') or #{p1.vehicle_no} is null or #{p1.vehicle_no} = '')                                                                                 "
            + "      and (DATE_FORMAT(t.c_time, '%Y-%m-%d' ) &gt;= #{p1.batch} or #{p1.batch} is null or #{p1.batch} = '')                                                                                           "
            + "   <if test='p1.type_list != null and p1.type_list.length!=0' >                                                                                                                                       "
            + "    and t.type in                                                                                                                                                                                     "
            + "        <foreach collection='p1.type_list' item='item' index='index' open='(' separator=',' close=')'>                                                                                                "
            + "         #{item}                                                                                                                                                                                      "
            + "        </foreach>                                                                                                                                                                                    "
            + "   </if>                                                                                                                                                                                              "
            + "   <if test='p1.status_list != null and p1.status_list.length!=0' >                                                                                                                                   "
            + "    and t.status in                                                                                                                                                                                   "
            + "        <foreach collection='p1.status_list' item='item' index='index' open='(' separator=',' close=')'>                                                                                              "
            + "         #{item}                                                                                                                                                                                      "
            + "        </foreach>                                                                                                                                                                                    "
            + "   </if>                                                                                                                                                                                              "
            + "      and (t9.warehouse_type = #{p1.warehouse_type} or #{p1.warehouse_type} is null or  #{p1.warehouse_type} = '')                                                                                    "
            //注意 exists里面使用count(1)需要配合分组使用 or 返回 IF(count( 1 )<1,NULL,true)
            + "    <if test='p1.todo_status == 0' >                                                                                                                                                             "
            + "  and exists (                                                                                                                                                                                   "
            + "		SELECT                                                                                                                                                                                      "
            + "				count(1)                                                                                                                                                                                   "
            + "			FROM                                                                                                                                                                                    "
            + "				b_todo subt1                                                                                                                                                                        "
            + "				INNER JOIN v_permission_operation_all subt2 ON subt2.staff_id = #{p1.staff_id,jdbcType=INTEGER}                                                                                     "
            + "				AND subt1.position_id = subt2.position_id                                                                                                                                           "
            + "				AND subt2.operation_perms = subt1.perms                                                                                                                                             "
            + "			WHERE                                                                                                                                                                                   "
            + "				t.id = subt1.serial_id                                                                                                                                                              "
            + "				AND subt1.serial_type = '" + SystemConstants.SERIAL_TYPE.B_DELIVERY + "'                                                                                                                     "
            + "				AND subt1.STATUS = '" + DictConstant.DICT_B_TODO_STATUS_TODO + "'                                                                                                                      "
            + "				GROUP BY subt1.serial_id, subt1.serial_type                                                                                                                                         "
            + "  )                                                                                                                                                                                              "
            + "      </if>                                                                                                                                                                                      "

            // 已办
            + "      <if test='p1.todo_status == 1' >                                                                                                                                                           "
            + "      and exists (                                                                                                                                                                               "
            + "             select count(1)                                                                                                                                                                           "
            + "               from b_already_do subt1                                                                                                                                                           "
            + "              where subt1.serial_type = '" + SystemConstants.SERIAL_TYPE.B_DELIVERY + "'                                                                                                               "
            + "                and subt1.staff_id = #{p1.staff_id,jdbcType=INTEGER}                                                                                                                             "
            + "                and serial_id = t.id                                                                                                                                                             "
            + "				GROUP BY subt1.serial_id, subt1.serial_type                                                                                                                                         "
            + "       )                                                                                                                                                                                         "
            + "      </if>                                                                                                                                                                                      "
            // 仓库权限
            + "     ${p1.params.dataScopeAnnotation}                                                                                                                                                                 "
            + "      </script> ")
    BDeliverySumVo selectSumData(@Param("p1") BDeliveryVo searchCondition);


    @Select("    "
            + common_select
            + "  where t.id =  #{p1,jdbcType=INTEGER}"
            + "      ")
    BDeliveryVo selectId(@Param("p1") Integer id);


    /**
     * 没有分页，按id筛选条件
     *
     * @param searchCondition
     * @return
     */
    @Select("   <script>   "
            + common_select
            + "  where t.id in                                                                                          "
            + "        <foreach collection='p1' item='item' index='index' open='(' separator=',' close=')'>             "
            + "         #{item.id,jdbcType=INTEGER}                                                                     "
            + "        </foreach>                                                                                       "
            + "  </script>    ")
    List<BDeliveryEntity> selectIdsIn(@Param("p1") List<BDeliveryVo> searchCondition);


    @Select("   "
            + common_select
            + "   where true                                                                                            "
            + "     and (t.id = #{p1.id,jdbcType=INTEGER} or #{p1.id,jdbcType=INTEGER} is null)                         "
            + "       ")
    List<BDeliveryVo> selectAllList(@Param("p1") BDeliveryVo searchCondition);


    /**
     * 导出页面查询列表
     */
    @Select(" <script>   "
            + common_select
            + "   where true                                                                                            "
            + "   <if test='p1 != null and p1.length!=0' >                                                              "
            + "    and t.id in                                                                                          "
            + "        <foreach collection='p1' item='item' index='index' open='(' separator=',' close=')'>             "
            + "         #{item.id,jdbcType=INTEGER}                                                                     "
            + "        </foreach>                                                                                       "
            + "   </if>                                                                                                 "
            + "    </script>    ")
    List<BDeliveryExportVo> selectExportList(@Param("p1") BDeliveryVo[] searchCondition);


    @Select("   <script> "
            + " ${p1.params.dataScopeAnnotation_with}                                                                                                                                                                "
            + "      SELECT                                                                                                                                                                                          "
            + "             @row_num:= @row_num+ 1 as excel_no,                                                                                                                                                                                         "
            + "             t.*,                                                                                                                                                                                     "
            + "             t10.no,                                                                                                                                                                                  "
            + "             t13.order_id,                                                                                                                                                                            "
            + "             t.price*t.actual_count total_price,                                                                                                                                                      "
            + "             t13.primary_quantity,                                                                                                                                                                    "
            + "             t13.car_count,                                                                                                                                                                           "
            + "             ifnull(t19.order_no ,t25.order_no) order_no,                                                                                                                                             "
            + "             ifnull(t19.ship_name ,t25.ship_name) ship_name ,                                                                                                                                         "
            + "             ifnull(t19.contract_no ,t25.contract_no) contract_no ,                                                                                                                                   "
            + "             ifnull(t19.contract_dt ,t25.contract_dt) contract_dt ,                                                                                                                                   "
            + "             ifnull(t19.contract_num ,t25.contract_num) contract_num,                                                                                                                                 "
            + "             t13.pound_file ,                                                                                                                                                                         "
            + "             t13.photo_file ,                                                                                                                                                                         "
            + "             t13.inspection_file ,                                                                                                                                                                    "
            + "             t13.goods_file ,                                                                                                                                                                         "
            + "             t3.extra_code,                                                                                                                                                                           "
            + "             t3.waybill_code,                                                                                                                                                                         "
            + "             t3.code as plan_code,                                                                                                                                                                    "
            + "             t3.id as plan_id,                                                                                                                                                                        "
            + "             t10.code as plan_son_code,                                                                                                                                                               "
            + "             t15.label as status_name,                                                                                                                                                                "
            + "             ifnull(t16.label,t21.label) as type_name,                                                                                                                                                "
            + "             t17.label as bill_type_name,                                                                                                                                                             "
            + "             ifnull(t4.short_name,t4.name) as consignor_name,                                                                                                                                         "
            + "             ifnull(t5.short_name,t5.name) as owner_name,                                                                                                                                             "
            + "             ifnull(t6.short_name,t6.name) as customer_name,                                                                                                                                          "
            + "             t9.short_name as warehouse_name,                                                                                                                                                         "
            + "             t9.name as warehouse_full_name,                                                                                                                                                          "
            + "             t7.name as bin_name,                                                                                                                                                                     "
            + "             t8.name as location_name,                                                                                                                                                                "
            + "             t11.spec,                                                                                                                                                                                "
            + "             t11.pm,                                                                                                                                                                                  "
            + "             t12.name as goods_name,                                                                                                                                                                  "
            + "             t18.src_unit as unit_name,                                                                                                                                                               "
            + "             t1.name as c_name,                                                                                                                                                                       "
            + "             t14.name as e_name,                                                                                                                                                                      "
            + "             t2.name as u_name,                                                                                                                                                                       "
            + "             t23.id as monitor_in_id,                                                                                                                                                                 "
            + "             t20.remark as cancel_remark,                                                                                                                                                             "
            + "             t.cancel_audit_dt,                                                                                                                                                                       "
            + "             t26.name as cancel_audit_name                                                                                                                                                            "
            + "        FROM                                                                                                                                                                                          "
            + "         	b_delivery t                                                                                                                                                                                 "
            + "   LEFT JOIN m_staff t1 ON t.c_id = t1.id                                                                                                                                                             "
            + "   LEFT JOIN m_staff t2 ON t.u_id = t2.id                                                                                                                                                             "
            + "   LEFT JOIN m_staff t14 ON t.e_id = t14.id                                                                                                                                                           "
            + "   LEFT JOIN b_delivery_extra t13 ON t13.delivery_id = t.id                                                                                                                                                     "
            + "   LEFT JOIN b_in_plan_detail t10 ON t10.id = t.plan_detail_id                                                                                                                                        "
            + "   LEFT JOIN b_in_plan t3 ON t3.id = t.plan_id                                                                                                                                                        "
            + "   LEFT JOIN b_order t19 on t10.order_id = t19.serial_id and t10.order_type = t19.serial_type                                                                                                         "
            + "   LEFT JOIN b_order t25 on t13.order_id = t25.serial_id and t13.order_type = t25.serial_type                                                                                                         "
            + "   LEFT JOIN m_customer t4 ON t.consignor_id = t4.id                                                                                                                                                  "
            + "   LEFT JOIN m_owner t5 ON t.owner_id = t5.id                                                                                                                                                         "
            + "   LEFT JOIN m_customer t6 ON t19.customer_id = t6.id                                                                                                                                                 "
            + "   LEFT JOIN m_bin t7 ON t7.id = t.bin_id                                                                                                                                                             "
            + "   LEFT JOIN m_location t8 ON t8.id = t.location_id                                                                                                                                                   "
            + "   LEFT JOIN m_warehouse t9 ON t9.id = t.warehouse_id                                                                                                                                                 "
            + "   LEFT JOIN m_goods_spec t11 ON t11.id = t.sku_id                                                                                                                                                    "
            + "   LEFT JOIN m_goods_spec_prop t24 ON t11.prop_id = t24.id                                                                                                                                            "
            + "   LEFT JOIN m_goods t12 ON t12.id = t11.goods_id                                                                                                                                                     "
            + "   LEFT JOIN v_dict_info t15 ON t15.code = '" + DictConstant.DICT_B_DELIVERY_STATUS + "' and t.status = t15.dict_value                                                                                      "
            + "   LEFT JOIN v_dict_info t16 ON t16.code = '" + DictConstant.DICT_B_DELIVERY_TYPE + "' and t3.type = t16.dict_value                                                                                         "
            + "   LEFT JOIN v_dict_info t17 ON t17.code = '" + DictConstant.DICT_B_DELIVERY_BUSINESS_TYPE + "' and t19.bill_type = t17.dict_value                                                                          "
            + "   LEFT JOIN m_goods_unit_calc t18 ON t18.src_unit_id = t.unit_id and t18.sku_id = t.sku_id                                                                                                           "
            + "   LEFT JOIN m_cancel t20 ON t20.serial_id = t.id and t20.serial_type = '" + SystemConstants.SERIAL_TYPE.B_DELIVERY + "'                                                                                    "
            + "   LEFT JOIN v_dict_info t21 ON t21.code = '" + DictConstant.DICT_B_DELIVERY_TYPE + "' and t.type = t21.dict_value                                                                                          "
            + "   LEFT JOIN b_sync_status_error t22 ON t.sync_id = t22.id                                                                                                                                            "
            // 判断是否是监管任务生产的入库单, 如果是, 不能删除
            + "   left join b_monitor_in t23 ON t23.in_id = t.id                                                                                                                                                     "
            + "   LEFT JOIN m_staff t26 ON t26.id = t.cancel_audit_id                                                                                                                                                "
            + "   ,(select @row_num:=0) t22                                                                                                         "
            + "   where true                                                                                                                                                                                         "
            + "      and (t.code like CONCAT ('%',#{p1.code,jdbcType=VARCHAR},'%') or #{p1.code,jdbcType=VARCHAR} is null or  #{p1.code,jdbcType=VARCHAR} ='')                                                       "
            + "      and (t3.code like CONCAT ('%',#{p1.plan_code,jdbcType=VARCHAR},'%') or #{p1.plan_code,jdbcType=VARCHAR} is null or #{p1.plan_code,jdbcType=VARCHAR} ='')                                        "
            + "      and (CONCAT(t5.name,t5.short_name,t5.name_pinyin,t5.short_name_pinyin) like CONCAT ('%',#{p1.owner_name,jdbcType=VARCHAR},'%') or #{p1.owner_name,jdbcType=VARCHAR} is null)                    "
            + "      and (CONCAT(t4.name,t4.short_name,t4.name_pinyin,t4.short_name_pinyin) like CONCAT ('%',#{p1.consignor_name,jdbcType=VARCHAR},'%') or #{p1.consignor_name,jdbcType=VARCHAR} is null)            "
            + "      and (t.warehouse_id = #{p1.warehouse_id,jdbcType=INTEGER} or #{p1.warehouse_id,jdbcType=INTEGER} is null)                                                                                       "
            + "      and (t.type = #{p1.type,jdbcType=VARCHAR} or #{p1.type,jdbcType=VARCHAR} is null or #{p1.type,jdbcType=VARCHAR} = '')                                                                           "
            + "      and (t13.bill_type = #{p1.bill_type,jdbcType=VARCHAR} or #{p1.bill_type,jdbcType=VARCHAR} is null or #{p1.bill_type,jdbcType=VARCHAR} ='')                                                      "
            + "      and (t.status = #{p1.status,jdbcType=VARCHAR} or #{p1.status,jdbcType=VARCHAR} is null or #{p1.status,jdbcType=VARCHAR} = '')                                                                   "
            + "      and (t12.name like CONCAT ('%',#{p1.goods_name,jdbcType=VARCHAR},'%')                                                                                                                           "
            + "           or t12.code like CONCAT ('%',#{p1.goods_name,jdbcType=VARCHAR},'%')                                                                                                                        "
            + "           or t11.spec like concat('%',#{p1.goods_name,jdbcType=VARCHAR},'%')                                                                                                                         "
            + "           or t.sku_code like concat('%',#{p1.goods_name,jdbcType=VARCHAR},'%')                                                                                                                       "
            + "           or #{p1.goods_name,jdbcType=VARCHAR} is null or #{p1.goods_name,jdbcType=VARCHAR} = '')                                                                                                    "
            + "      and (t19.contract_no like CONCAT ('%',#{p1.contract_no,jdbcType=VARCHAR},'%') or t25.contract_no like CONCAT ('%',#{p1.contract_no,jdbcType=VARCHAR},'%') or #{p1.contract_no,jdbcType=VARCHAR} is null)                                                                    "
            + "      and (t19.ship_name like CONCAT ('%',#{p1.ship_name,jdbcType=VARCHAR},'%') or t25.ship_name like CONCAT ('%',#{p1.ship_name,jdbcType=VARCHAR},'%') or #{p1.ship_name,jdbcType=VARCHAR} is null)                                                                          "
            + "      and (t19.customer_id = #{p1.customer_id,jdbcType=INTEGER} or t25.customer_id = #{p1.customer_id,jdbcType=INTEGER} or #{p1.customer_id,jdbcType=INTEGER} is null)                                                                                        "
            + "      and (CONCAT(ifnull(t6.name,''),ifnull(t6.short_name,''),ifnull(t6.name_pinyin,''),ifnull(t6.short_name_pinyin,'')) like CONCAT ('%',#{p1.customer_name,jdbcType=VARCHAR},'%') or #{p1.customer_name,jdbcType=VARCHAR} is null)              "
            + "      and (date_format(t.inbound_time, '%Y-%m-%d') &gt;= date_format(#{p1.start_time,jdbcType=DATE}, '%Y-%m-%d') or #{p1.start_time,jdbcType=DATE} is null)                                           "
            + "      and (date_format(t.inbound_time, '%Y-%m-%d') &lt;= date_format(#{p1.over_time,jdbcType=DATE}, '%Y-%m-%d') or #{p1.over_time,jdbcType=DATE} is null)                                             "
            + "      and (date_format(t.e_dt, '%Y-%m-%d') &gt;= #{p1.e_dt_start} or #{p1.e_dt_start} is null)                                                                                                        "
            + "      and (date_format(t.e_dt, '%Y-%m-%d') &lt;= #{p1.e_dt_end} or #{p1.e_dt_end} is null)                                                                                                            "
            + "      and (t24.name like concat('%', #{p1.prop}, '%') or #{p1.prop} is null or #{p1.prop} = '')                                                                                                       "
            + "      and (t3.waybill_code like concat('%', #{p1.waybill_code}, '%') or #{p1.waybill_code} is null or #{p1.waybill_code} = '')                                                                        "
            + "      and (t22.status = #{p1.sync_status} or #{p1.sync_status} is null or #{p1.sync_status} = '')                                                                                                     "
            + "      and (date_format(t.c_time, '%Y-%m-%d') &gt;= date_format(#{p1.c_time_start}, '%Y-%m-%d') or #{p1.c_time_start} is null)                                                                         "
            + "      and (date_format(t.c_time, '%Y-%m-%d') &lt;= date_format(#{p1.c_time_end}, '%Y-%m-%d') or #{p1.c_time_end} is null)                                                                             "
            + "      and (t.vehicle_no like concat('%', #{p1.vehicle_no}, '%') or #{p1.vehicle_no} is null or #{p1.vehicle_no} = '')                                                                                 "
            + "      and (DATE_FORMAT(t.c_time, '%Y-%m-%d' ) &gt;= #{p1.batch} or #{p1.batch} is null or #{p1.batch} = '')                                                                                           "
            + "   <if test='p1.type_list != null and p1.type_list.length!=0' >                                                                                                                                       "
            + "    and t.type in                                                                                                                                                                                     "
            + "        <foreach collection='p1.type_list' item='item' index='index' open='(' separator=',' close=')'>                                                                                                "
            + "         #{item}                                                                                                                                                                                      "
            + "        </foreach>                                                                                                                                                                                    "
            + "   </if>                                                                                                                                                                                              "
            + "   <if test='p1.status_list != null and p1.status_list.length!=0' >                                                                                                                                   "
            + "    and t.status in                                                                                                                                                                                   "
            + "        <foreach collection='p1.status_list' item='item' index='index' open='(' separator=',' close=')'>                                                                                              "
            + "         #{item}                                                                                                                                                                                      "
            + "        </foreach>                                                                                                                                                                                    "
            + "   </if>                                                                                                                                                                                              "
            + "      and (t9.warehouse_type = #{p1.warehouse_type} or #{p1.warehouse_type} is null or  #{p1.warehouse_type} = '')                                                                                    "
            //注意 exists里面使用count(1)需要配合分组使用 or 返回 IF(count( 1 )<1,NULL,true)
            + "    <if test='p1.todo_status == 0' >                                                                                                                                                             "
            + "  and exists (                                                                                                                                                                                   "
            + "		SELECT                                                                                                                                                                                      "
            + "				count(1)                                                                                                                                                                                   "
            + "			FROM                                                                                                                                                                                    "
            + "				b_todo subt1                                                                                                                                                                        "
            + "				INNER JOIN v_permission_operation_all subt2 ON subt2.staff_id = #{p1.staff_id,jdbcType=INTEGER}                                                                                     "
            + "				AND subt1.position_id = subt2.position_id                                                                                                                                           "
            + "				AND subt2.operation_perms = subt1.perms                                                                                                                                             "
            + "			WHERE                                                                                                                                                                                   "
            + "				t.id = subt1.serial_id                                                                                                                                                              "
            + "				AND subt1.serial_type = '" + SystemConstants.SERIAL_TYPE.B_DELIVERY + "'                                                                                                                     "
            + "				AND subt1.STATUS = '" + DictConstant.DICT_B_TODO_STATUS_TODO + "'                                                                                                                      "
            + "				GROUP BY subt1.serial_id, subt1.serial_type                                                                                                                                         "
            + "  )                                                                                                                                                                                              "
            + "      </if>                                                                                                                                                                                      "

            // 已办
            + "      <if test='p1.todo_status == 1' >                                                                                                                                                           "
            + "      and exists (                                                                                                                                                                               "
            + "             select count(1)                                                                                                                                                                           "
            + "               from b_already_do subt1                                                                                                                                                           "
            + "              where subt1.serial_type = '" + SystemConstants.SERIAL_TYPE.B_DELIVERY + "'                                                                                                               "
            + "                and subt1.staff_id = #{p1.staff_id,jdbcType=INTEGER}                                                                                                                             "
            + "                and serial_id = t.id                                                                                                                                                             "
            + "				GROUP BY subt1.serial_id, subt1.serial_type                                                                                                                                         "
            + "       )                                                                                                                                                                                         "
            + "      </if>                                                                                                                                                                                      "

            // 仓库权限
            + "     ${p1.params.dataScopeAnnotation}                                                                                                                                                                 "
            + "      </script> ")
    List<BDeliveryExportVo> selectAllExportList(@Param("p1") BDeliveryVo searchCondition);

    /**
     * 监管任务入库id查询提货单数据
     */
    @Select("                                                                                                          "
            + "     SELECT                                                                                             "
            + "            t4.owner_id,                                                                                "
            + "            t4.owner_code,                                                                              "
            + "            t4.consignor_id,                                                                            "
            + "            t4.consignor_code,                                                                          "
            + "            t3.plan_id as plan_id,                                                                      "
            + "            t3.id as plan_detail_id,                                                                    "
            + "            t.in_warehouse_id as warehouse_id,                                                          "
            + "            t.in_location_id as location_id,                                                            "
            + "            t.in_bin_id as bin_id,                                                                      "
            + "            t3.sku_id,                                                                                  "
            + "            t3.sku_code,                                                                                "
            + "            t4.type,                                                                                    "
            + "            t3.count as plan_count,                                                                     "
            + "            t3.weight as plan_weight,                                                                   "
            + "            0 as plan_volume,                                                                           "
            + "            t3.unit_id,                                                                                 "
            + "            t5.price,                                                                                   "
            + "            t5.price*t2.qty amount                                                                      "
            + "       FROM                                                                                             "
            + "  	       b_schedule t                                                                                "
            + "  LEFT JOIN b_monitor  t1 ON t1.schedule_id = t.id                                                      "
            + "  LEFT JOIN b_monitor_in  t2 ON t2.monitor_id = t1.id                                                   "
            + "  LEFT JOIN b_in_plan_detail  t3 ON t3.id = t.in_plan_detail_id                                         "
            + "  LEFT JOIN b_in_plan  t4 ON t4.id = t3.plan_id                                                         "
            + "  LEFT JOIN (                                                                                           "
            + "		SELECT                                                                                             "
            + "			t1.id,ifnull(t3.price, 0) price,t3.sku_id,t3.no                                                "
            + "		FROM                                                                                               "
            + "			b_order t1                                                                                     "
            + "			JOIN b_in_order t2 ON t1.serial_id = t2.id                                                     "
            + "			AND t1.serial_type = 'b_in_order'                                                              "
            + "			LEFT JOIN b_in_order_goods t3 ON t2.id = t3.order_id                                           "
            + "			union all                                                                                      "
            + "		SELECT                                                                                             "
            + "			t1.id,ifnull(t3.price, 0) price ,t3.sku_id,t3.no                                               "
            + "		FROM                                                                                               "
            + "			b_order t1                                                                                     "
            + "			JOIN b_out_order t2 ON t1.serial_id = t2.id                                                    "
            + "			AND t1.serial_type = 'b_out_order'                                                             "
            + "			LEFT JOIN b_out_order_goods t3 ON t2.id = t3.order_id                                          "
            + "     )t5 on t.order_id = t5.id  and t.sku_id = t5.sku_id and t3.order_detail_no = t5.no                 "
            + "     where true                                                                                         "
            + "     and t2.id = #{p1,jdbcType=INTEGER}                                                                 "
            + "  ")
    BDeliveryEntity selectByMonitorInId(@Param("p1") Integer id);

}
