package com.xinyirun.scm.core.system.mapper.business.wms.out.receive;


import com.baomidou.mybatisplus.core.mapper.BaseMapper;
import com.xinyirun.scm.bean.entity.busniess.wms.out.receive.BReceiveEntity;
import com.xinyirun.scm.bean.system.vo.business.wms.out.receive.BReceiveSumVo;
import com.xinyirun.scm.bean.system.vo.business.wms.out.receive.BReceiveVo;
import com.xinyirun.scm.bean.system.vo.excel.out.BReceiveExportVo;
import com.xinyirun.scm.common.constant.DictConstant;
import com.xinyirun.scm.common.constant.SystemConstants;
import org.apache.ibatis.annotations.Param;
import org.apache.ibatis.annotations.Select;
import org.springframework.stereotype.Repository;

import java.util.List;

/**
 * <p>
 * 收货单 Mapper 接口
 * </p>
 *
 * @author xinyirun
 * @since 2024-07-01
 */
@Repository
public interface BReceiveMapper extends BaseMapper<BReceiveEntity> {


    String select_sql =" SELECT                                                                                                                                                         "
            + "             @row_num:= @row_num + 1 as excel_no,                                                                                     "
            + "             t.*,                                                                                                                                                        "
            + "             t3.release_order_code,                                                                                                                                      "
            + "             t13.no,                                                                                                                                                     "
            + "             t13.type_gauge,                                                                                                                                             "
            + "             t13.alias,                                                                                                                                                  "
            + "             ifnull(t19.contract_dt, t10.contract_dt) contract_dt,                                                                                                       "
            + "             ifnull(t19.contract_num, t10.contract_num) contract_num,                                                                                                    "
            + "             ifnull(t19.contract_no, t10.contract_no) contract_no,                                                                                                       "
            + "             t19.order_no,                                                                                                                                               "
            + "             t19.bill_type,                                                                                                                                              "
            + "             t10.pound_file,                                                                                                                                             "
            + "             t10.out_photo_file,                                                                                                                                         "
            + "             t13.code as detail_code,                                                                                                                                    "
            + "             t3.code as plan_code,                                                                                                                                       "
            + "             t3.extra_code,                                                                                                                                              "
            + "             t15.label as status_name,                                                                                                                                   "
            + "             ifnull(t16.label, t10.label) as bill_type_name,                                                                                                             "
            + "             ifnull(t17.label, t22.label) as type_name,                                                                                                                  "
            + "             ifnull(t4.short_name,t4.name) as consignor_name,                                                                                                            "
            + "             ifnull(t5.short_name,t5.name) as owner_name,                                                                                                                "
            + "             t9.short_name as warehouse_name,                                                                                                                            "
            + "             t9.name as warehouse_full_name,                                                                                                                             "
            + "             t7.name as bin_name,                                                                                                                                        "
            + "             t8.name as location_name,                                                                                                                                   "
            + "             t11.spec,                                                                                                                                                   "
            + "             t11.pm,                                                                                                                                                     "
            + "             t11.code as sku_code,                                                                                                                                       "
            + "             t12.name as goods_name,                                                                                                                                     "
            + "             t20.name as unit_name,                                                                                                                                      "
            + "             t1.name as c_name,                                                                                                                                          "
            + "             t14.name as e_name,                                                                                                                                         "
            + "             ifnull(tt2.name, t10.name) as client_name,                                                                                                                  "
            + "             t2.name as u_name,                                                                                                                                          "
            + "             t21.remark as cancel_remark,                                                                                                                                "
            + "             t27.name as cancel_audit_name,                                                                                                                              "
            + "             t.cancel_audit_dt                                                                                                                                          "
            + "        FROM                                                                                                                                                             "
            + "         	  b_receive t                                                                                                                                               "
            + "   LEFT JOIN m_staff t1 ON t.c_id = t1.id                                                                                                                                "
            + "   LEFT JOIN m_staff t2 ON t.u_id = t2.id                                                                                                                                "
            + "   LEFT JOIN m_staff t14 ON t.e_id = t14.id                                                                                                                              "
            + "   LEFT JOIN b_out_plan_detail t13 ON t.plan_detail_id = t13.id                                                                                                          "
            + "   LEFT JOIN b_out_plan t3 ON t.plan_id = t3.id                                                                                                                          "
            + "   LEFT JOIN b_order t19 on t13.order_id = t19.serial_id and t13.order_type = t19.serial_type                                                                            "
            + "   LEFT JOIN m_customer tt2 ON tt2.id = t19.customer_id                                                                                                                  "
            + "   LEFT JOIN m_customer t4 ON t.consignor_id = t4.id                                                                                                                     "
            + "   LEFT JOIN m_owner t5 ON t.owner_id = t5.id                                                                                                                            "
            + "   LEFT JOIN m_bin t7 ON t.bin_id = t7.id                                                                                                                                "
            + "   LEFT JOIN m_location t8 ON t.location_id = t8.id                                                                                                                      "
            + "   LEFT JOIN m_warehouse t9 ON t.warehouse_id = t9.id                                                                                                                    "
            + "   LEFT JOIN m_goods_spec t11 ON t11.id = t.sku_id                                                                                                                       "
            + "   LEFT JOIN m_goods_spec_prop t24 ON t11.prop_id = t24.id                                                                                                               "
            + "   LEFT JOIN m_goods t12 ON t12.id = t11.goods_id                                                                                                                        "
            + "   LEFT JOIN (select tab1.out_photo_file, tab1.pound_file, tab1.contract_no, tab1.contract_num, tab1.contract_dt, tab1.receive_id, tab1.bill_type, tab3.label, tab2.name     "
            + "              from b_receive_extra tab1 left join m_customer tab2 on tab1.client_id = tab2.id                                                                                "
            + "              left join (select tab1.dict_value, tab1.label from s_dict_data tab1 inner join s_dict_type tab2 on tab1.dict_type_id = tab2.id                             "
            + "              where tab2.code = '" + DictConstant.DICT_B_RECEIVE_BUSINESS_TYPE + "') tab3 ON tab3.dict_value = tab1.bill_type ) t10 ON t10.receive_id = t.id                 "
            + "   LEFT JOIN (select tab1.* from s_dict_data tab1 inner join s_dict_type tab2 on tab1.dict_type_id = tab2.id                                                             "
            + "              where tab2.code = '" + DictConstant.DICT_B_RECEIVE_STATUS + "')t15 on t15.dict_value = t.status                                                            "
            + "   LEFT JOIN (select tab1.* from s_dict_data tab1 inner join s_dict_type tab2 on tab1.dict_type_id = tab2.id                                                             "
            + "              where tab2.code = '" + DictConstant.DICT_B_RECEIVE_BUSINESS_TYPE + "')t16 ON t16.dict_value = t19.bill_type                                                "
            + "   LEFT JOIN (select tab1.* from s_dict_data tab1 inner join s_dict_type tab2 on tab1.dict_type_id = tab2.id                                                             "
            + "              where tab2.code = '" + DictConstant.DICT_B_RECEIVE_TYPE + "')t17 ON t17.dict_value = t3.type                                                               "
            + "   LEFT JOIN m_unit t20 ON t20.id = t.unit_id                                                                                                                            "
            + "   LEFT JOIN m_cancel t21 ON t21.serial_id = t.id and t21.serial_type = '" + SystemConstants.SERIAL_TYPE.B_RECEIVE + "'                                                      "
            + "   LEFT JOIN (select tab1.* from s_dict_data tab1 inner join s_dict_type tab2 on tab1.dict_type_id = tab2.id                                                             "
            + "              where tab2.code = '" + DictConstant.DICT_B_RECEIVE_TYPE + "')t22 ON t22.dict_value = t.type                                                                "
            + "   LEFT JOIN b_sync_status_error t25 ON t.sync_id = t25.id                                                                                                               "
            + "   left join m_staff t27 ON t27.id = t.cancel_audit_id                                                                                                                   "
            + "   ,(select @row_num:=0) t28                                                                                                                                             "
            + "   where true                                                                                                                                                            ";



    @Select(" <script>   "
            + " ${p1.params.dataScopeAnnotation_with}                                                                                                                                                           "
            +        select_sql
            + "      and (t.code like CONCAT ('%',#{p1.code,jdbcType=VARCHAR},'%') or #{p1.code,jdbcType=VARCHAR} is null or #{p1.code,jdbcType=VARCHAR} = '')                                                  "
            + "      and (t3.code like CONCAT ('%',#{p1.plan_code,jdbcType=VARCHAR},'%') or #{p1.plan_code,jdbcType=VARCHAR} is null or #{p1.plan_code,jdbcType=VARCHAR} = '')                                  "
            + "      and (CONCAT(t5.name,t5.short_name,t5.name_pinyin,t5.short_name_pinyin) like CONCAT ('%',#{p1.owner_name,jdbcType=VARCHAR},'%') or #{p1.owner_name,jdbcType=VARCHAR} is null)               "
            + "      and (CONCAT(t4.name,t4.short_name,t4.name_pinyin,t4.short_name_pinyin) like CONCAT ('%',#{p1.consignor_name,jdbcType=VARCHAR},'%') or #{p1.consignor_name,jdbcType=VARCHAR} is null)       "
            + "      and (t.warehouse_id = #{p1.warehouse_id,jdbcType=INTEGER} or #{p1.warehouse_id,jdbcType=INTEGER} is null)                                                                                  "
            + "      and (t3.type = #{p1.type,jdbcType=VARCHAR} or #{p1.type,jdbcType=VARCHAR} is null or #{p1.type,jdbcType=VARCHAR} = '')                                                                     "
            + "      and (t13.type_gauge like CONCAT ('%',#{p1.type_gauge,jdbcType=VARCHAR},'%') or #{p1.type_gauge,jdbcType=VARCHAR} is null or #{p1.type_gauge,jdbcType=VARCHAR} = '')                        "
            + "      and (t13.alias like CONCAT ('%',#{p1.alias,jdbcType=VARCHAR},'%') or #{p1.alias,jdbcType=VARCHAR} is null or #{p1.alias,jdbcType=VARCHAR} = '')                                            "
            + "      and (ifnull(t19.bill_type, t10.bill_type) = #{p1.bill_type,jdbcType=VARCHAR} or #{p1.bill_type,jdbcType=VARCHAR} is null or #{p1.bill_type,jdbcType=VARCHAR} ='')                          "
            + "      and (t.status = #{p1.status,jdbcType=VARCHAR} or #{p1.status,jdbcType=VARCHAR} is null or #{p1.status,jdbcType=VARCHAR} = '')                                                              "
            + "      and (t12.name like CONCAT ('%',#{p1.goods_name,jdbcType=VARCHAR},'%')                                                                                                                      "
            + "           or t11.spec like CONCAT ('%',#{p1.goods_name,jdbcType=VARCHAR},'%')                                                                                                                   "
            + "           or t.sku_code like CONCAT ('%',#{p1.goods_name,jdbcType=VARCHAR},'%')                                                                                                                 "
            + "           or t12.code like CONCAT ('%',#{p1.goods_name,jdbcType=VARCHAR},'%') or #{p1.goods_name,jdbcType=VARCHAR} is null or #{p1.goods_name,jdbcType=VARCHAR} = ''  )                         "
            + "      and (ifnull(t19.contract_no, t10.contract_no) like CONCAT ('%',#{p1.contract_no,jdbcType=VARCHAR},'%')  or #{p1.contract_no,jdbcType=VARCHAR} is null)                                     "
            + "      and (date_format(t.outbound_time, '%Y-%m-%d') &gt;= date_format(#{p1.start_time,jdbcType=DATE}, '%Y-%m-%d') or #{p1.start_time,jdbcType=DATE} is null)                                     "
            + "      and (date_format(t.outbound_time, '%Y-%m-%d') &lt;= date_format(#{p1.over_time,jdbcType=DATE}, '%Y-%m-%d') or #{p1.over_time,jdbcType=DATE} is null)                                       "
            + "      and (date_format(t.e_dt, '%Y-%m-%d') &gt;= #{p1.ed_dt_start} or #{p1.ed_dt_start} is null)                                                                                                 "
            + "      and (date_format(t.e_dt, '%Y-%m-%d') &lt;= #{p1.ed_dt_end} or #{p1.ed_dt_end} is null)                                                                                                     "
            + "      and (t24.name like concat('%', #{p1.prop}, '%') or #{p1.prop} is null or #{p1.prop} = '')                                                                                                  "
            + "      and (ifnull(tt2.name, t10.name) like concat('%', #{p1.client_name}, '%') or #{p1.client_name} is null or #{p1.client_name} = '')                                                           "
            + "      and (t25.status = #{p1.sync_status} or #{p1.sync_status} is null or #{p1.sync_status} = '')                                                                                                "
            + "      and (date_format(t.c_time, '%Y-%m-%d') &gt;= date_format(#{p1.c_time_start}, '%Y-%m-%d') or #{p1.c_time_start} is null)                                                                    "
            + "      and (date_format(t.c_time, '%Y-%m-%d') &lt;= date_format(#{p1.c_time_end}, '%Y-%m-%d') or #{p1.c_time_end} is null)                                                                        "
            + "      and (DATE_FORMAT(t.c_time, '%Y-%m-%d' ) &gt;= #{p1.batch} or #{p1.batch} is null or #{p1.batch} = '')                                                                                      "
            + "      <if test='p1.status_list != null and p1.status_list.length!=0' >                                                                                                                           "
            + "       and t.status in                                                                                                                                                                           "
            + "           <foreach collection='p1.status_list' item='item' index='index' open='(' separator=',' close=')'>                                                                                      "
            + "            #{item}                                                                                                                                                                              "
            + "           </foreach>                                                                                                                                                                            "
            + "      </if>                                                                                                                                                                                      "
            + "      <if test='p1.type_list != null and p1.type_list.length!=0' >                                                                                                                               "
            + "       and t.type in                                                                                                                                                                             "
            + "           <foreach collection='p1.type_list' item='item' index='index' open='(' separator=',' close=')'>                                                                                        "
            + "            #{item}                                                                                                                                                                              "
            + "           </foreach>                                                                                                                                                                            "
            + "      </if>                                                                                                                                                                                      "
            + "      and (t.vehicle_no like concat('%', #{p1.vehicle_no}, '%') or #{p1.vehicle_no} is null or #{p1.vehicle_no} = '')                                                                            "
            + "      and (t9.warehouse_type = #{p1.warehouse_type} or #{p1.warehouse_type} is null or #{p1.warehouse_type} = '')                                                                                "
            //注意 exists里面使用count(1)需要配合分组使用 or 返回 IF(count( 1 )<1,NULL,true)
            + "    <if test='p1.todo_status == 0' >                                                                                                                                                             "
            + "  and exists (                                                                                                                                                                                   "
            + "		SELECT                                                                                                                                                                                      "
            + "				count(1)                                                                                                                                                                            "
            + "			FROM                                                                                                                                                                                    "
            + "				b_todo subt1                                                                                                                                                                        "
            + "				INNER JOIN v_permission_operation_all subt2 ON subt2.staff_id = #{p1.staff_id,jdbcType=INTEGER}                                                                                     "
            + "				AND subt1.position_id = subt2.position_id                                                                                                                                           "
            + "				AND subt2.operation_perms = subt1.perms                                                                                                                                             "
            + "			WHERE                                                                                                                                                                                   "
            + "				t.id = subt1.serial_id                                                                                                                                                              "
            + "				AND subt1.serial_type = '"+ SystemConstants.SERIAL_TYPE.B_RECEIVE+"'                                                                                                                "
            + "				AND subt1.STATUS = '"+ DictConstant.DICT_B_TODO_STATUS_TODO+"'                                                                                                                      "
            + "				GROUP BY subt1.serial_id, subt1.serial_type                                                                                                                                         "
            + "  )                                                                                                                                                                                              "
            + "      </if>                                                                                                                                                                                      "

            // 已办
            + "      <if test='p1.todo_status == 1' >                                                                                                                                                           "
            + "      and exists (                                                                                                                                                                               "
            + "             select count(1)                                                                                                                                                                     "
            + "               from b_already_do subt1                                                                                                                                                           "
            + "              where subt1.serial_type = '" + SystemConstants.SERIAL_TYPE.B_RECEIVE + "'                                                                                                          "
            + "                and subt1.staff_id = #{p1.staff_id,jdbcType=INTEGER}                                                                                                                             "
            + "                and serial_id = t.id                                                                                                                                                             "
            + "				GROUP BY subt1.serial_id, subt1.serial_type                                                                                                                                         "
            + "       )                                                                                                                                                                                         "
            + "      </if>                                                                                                                                                                                      "

            // 仓库权限
            + "     ${p1.params.dataScopeAnnotation}                                                                                                                                                            "
            + "    ORDER BY ${p2} ${p3} ${p4}                                                                                                                                                                   "
            + "    limit ${(p1.pageCondition.current-1)*p1.pageCondition.size},  #{p1.pageCondition.size}                                                                                                       "
            + "      </script> ")
    List<BReceiveVo> selectPageListNotCount(@Param("p1") BReceiveVo searchCondition, @Param("p2") String sort, @Param("p3") String sortType, @Param("p4") String defaultSort);


    @Select(" <script>   "
            + " ${p1.params.dataScopeAnnotation_with}                                                                                                                                 "
            + " SELECT                                                                                                                                                                "
            + "   count(1) c                                                                                                                                                          "
            + "   FROM                                                                                                                                                                "
            + "         	b_receive t                                                                                                                                               "
            + "   LEFT JOIN m_staff t1 ON t.c_id = t1.id                                                                                                                              "
            + "   LEFT JOIN m_staff t2 ON t.u_id = t2.id                                                                                                                              "
            + "   LEFT JOIN m_staff t14 ON t.e_id = t14.id                                                                                                                            "
            + "   LEFT JOIN b_out_plan_detail t13 ON t.plan_detail_id = t13.id                                                                                                        "
            + "   LEFT JOIN b_out_plan t3 ON t.plan_id = t3.id                                                                                                                        "
            + "   LEFT JOIN b_order t19 on t13.order_id = t19.serial_id and t13.order_type = t19.serial_type                                                                          "
            + "   LEFT JOIN m_customer tt2 ON tt2.id = t19.customer_id                                                                                                                "
            + "   LEFT JOIN m_customer t4 ON t.consignor_id = t4.id                                                                                                                   "
            + "   LEFT JOIN m_owner t5 ON t.owner_id = t5.id                                                                                                                          "
            + "   LEFT JOIN m_bin t7 ON t.bin_id = t7.id                                                                                                                              "
            + "   LEFT JOIN m_location t8 ON t.location_id = t8.id                                                                                                                    "
            + "   LEFT JOIN m_warehouse t9 ON t.warehouse_id = t9.id                                                                                                                  "
            + "   LEFT JOIN m_goods_spec t11 ON t11.id = t.sku_id                                                                                                                     "
            + "   LEFT JOIN m_goods_spec_prop t24 ON t11.prop_id = t24.id      "
            + "   LEFT JOIN m_goods t12 ON t12.id = t11.goods_id                                                                                                                      "
            + "   LEFT JOIN (select tab1.out_photo_file, tab1.pound_file, tab1.contract_no, tab1.contract_num, tab1.contract_dt, tab1.receive_id, tab1.bill_type, tab3.label, tab2.name   "
            + "               from b_receive_extra tab1 left join m_customer tab2 on tab1.client_id = tab2.id                                                                             "
            + "              left join (select tab1.dict_value, tab1.label from s_dict_data tab1 inner join s_dict_type tab2 on tab1.dict_type_id = tab2.id                           "
            + "              where tab2.code = '" + DictConstant.DICT_B_RECEIVE_BUSINESS_TYPE + "') tab3 ON tab3.dict_value = tab1.bill_type ) t10 ON t10.receive_id = t.id               "
            + "   LEFT JOIN (select tab1.* from s_dict_data tab1 inner join s_dict_type tab2 on tab1.dict_type_id = tab2.id                                                           "
            + "              where tab2.code = '" + DictConstant.DICT_B_RECEIVE_STATUS + "')t15 on t15.dict_value = t.status                                                          "
            + "   LEFT JOIN (select tab1.* from s_dict_data tab1 inner join s_dict_type tab2 on tab1.dict_type_id = tab2.id                                                           "
            + "              where tab2.code = '" + DictConstant.DICT_B_RECEIVE_BUSINESS_TYPE + "')t16 ON t16.dict_value = t19.bill_type                                              "
            + "   LEFT JOIN (select tab1.* from s_dict_data tab1 inner join s_dict_type tab2 on tab1.dict_type_id = tab2.id                                                           "
            + "              where tab2.code = '" + DictConstant.DICT_B_RECEIVE_TYPE + "')t17 ON t17.dict_value = t3.type                                                             "
            + "   LEFT JOIN m_unit t20 ON t20.id = t.unit_id                                                                                                                          "
            + "   LEFT JOIN m_cancel t21 ON t21.serial_id = t.id and t21.serial_type = '" + SystemConstants.SERIAL_TYPE.B_OUT + "'                                                    "
            + "   LEFT JOIN (select tab1.* from s_dict_data tab1 inner join s_dict_type tab2 on tab1.dict_type_id = tab2.id                                                           "
            + "              where tab2.code = '" + DictConstant.DICT_B_RECEIVE_TYPE + "')t22 ON t22.dict_value = t.type                                                              "
            + "   LEFT JOIN b_sync_status_error t25 ON t.sync_id = t25.id                                                                                                             "
            + "   left join m_staff t27 ON t27.id = t.cancel_audit_id                                                                                                                 "
            + "   where true                                                                                                                                                          "
            + "      and (t.code like CONCAT ('%',#{p1.code,jdbcType=VARCHAR},'%') or #{p1.code,jdbcType=VARCHAR} is null or #{p1.code,jdbcType=VARCHAR} = '')                                                  "
            + "      and (t3.code like CONCAT ('%',#{p1.plan_code,jdbcType=VARCHAR},'%') or #{p1.plan_code,jdbcType=VARCHAR} is null or #{p1.plan_code,jdbcType=VARCHAR} = '')                                  "
            + "      and (CONCAT(t5.name,t5.short_name,t5.name_pinyin,t5.short_name_pinyin) like CONCAT ('%',#{p1.owner_name,jdbcType=VARCHAR},'%') or #{p1.owner_name,jdbcType=VARCHAR} is null)               "
            + "      and (CONCAT(t4.name,t4.short_name,t4.name_pinyin,t4.short_name_pinyin) like CONCAT ('%',#{p1.consignor_name,jdbcType=VARCHAR},'%') or #{p1.consignor_name,jdbcType=VARCHAR} is null)       "
            + "      and (t.warehouse_id = #{p1.warehouse_id,jdbcType=INTEGER} or #{p1.warehouse_id,jdbcType=INTEGER} is null)                                                                                  "
            + "      and (t3.type = #{p1.type,jdbcType=VARCHAR} or #{p1.type,jdbcType=VARCHAR} is null or #{p1.type,jdbcType=VARCHAR} = '')                                                                     "
            + "      and (t13.type_gauge like CONCAT ('%',#{p1.type_gauge,jdbcType=VARCHAR},'%') or #{p1.type_gauge,jdbcType=VARCHAR} is null or #{p1.type_gauge,jdbcType=VARCHAR} = '')                        "
            + "      and (t13.alias like CONCAT ('%',#{p1.alias,jdbcType=VARCHAR},'%') or #{p1.alias,jdbcType=VARCHAR} is null or #{p1.alias,jdbcType=VARCHAR} = '')                                            "
            + "      and (ifnull(t19.bill_type, t10.bill_type) = #{p1.bill_type,jdbcType=VARCHAR} or #{p1.bill_type,jdbcType=VARCHAR} is null or #{p1.bill_type,jdbcType=VARCHAR} ='')                          "
            + "      and (t.status = #{p1.status,jdbcType=VARCHAR} or #{p1.status,jdbcType=VARCHAR} is null or #{p1.status,jdbcType=VARCHAR} = '')                                                              "
            + "      and (t12.name like CONCAT ('%',#{p1.goods_name,jdbcType=VARCHAR},'%')                                                                                                                      "
            + "           or t11.spec like CONCAT ('%',#{p1.goods_name,jdbcType=VARCHAR},'%')                                                                                                                   "
            + "           or t.sku_code like CONCAT ('%',#{p1.goods_name,jdbcType=VARCHAR},'%')                                                                                                                 "
            + "           or t12.code like CONCAT ('%',#{p1.goods_name,jdbcType=VARCHAR},'%') or #{p1.goods_name,jdbcType=VARCHAR} is null or #{p1.goods_name,jdbcType=VARCHAR} = ''  )                         "
            + "      and (ifnull(t19.contract_no, t10.contract_no) like CONCAT ('%',#{p1.contract_no,jdbcType=VARCHAR},'%')  or #{p1.contract_no,jdbcType=VARCHAR} is null)                                     "
            + "      and (date_format(t.outbound_time, '%Y-%m-%d') &gt;= date_format(#{p1.start_time,jdbcType=DATE}, '%Y-%m-%d') or #{p1.start_time,jdbcType=DATE} is null)                                     "
            + "      and (date_format(t.outbound_time, '%Y-%m-%d') &lt;= date_format(#{p1.over_time,jdbcType=DATE}, '%Y-%m-%d') or #{p1.over_time,jdbcType=DATE} is null)                                       "
            + "      and (date_format(t.e_dt, '%Y-%m-%d') &gt;= #{p1.ed_dt_start} or #{p1.ed_dt_start} is null)                                                                                                 "
            + "      and (date_format(t.e_dt, '%Y-%m-%d') &lt;= #{p1.ed_dt_end} or #{p1.ed_dt_end} is null)                                                                                                     "
            + "      and (t24.name like concat('%', #{p1.prop}, '%') or #{p1.prop} is null or #{p1.prop} = '')                                                                                                  "
            + "      and (ifnull(tt2.name, t10.name) like concat('%', #{p1.client_name}, '%') or #{p1.client_name} is null or #{p1.client_name} = '')                                                           "
            + "      and (t25.status = #{p1.sync_status} or #{p1.sync_status} is null or #{p1.sync_status} = '')                                                                                                "
            + "      and (date_format(t.c_time, '%Y-%m-%d') &gt;= date_format(#{p1.c_time_start}, '%Y-%m-%d') or #{p1.c_time_start} is null)                                                                    "
            + "      and (date_format(t.c_time, '%Y-%m-%d') &lt;= date_format(#{p1.c_time_end}, '%Y-%m-%d') or #{p1.c_time_end} is null)                                                                        "
            + "      and (DATE_FORMAT(t.c_time, '%Y-%m-%d' ) &gt;= #{p1.batch} or #{p1.batch} is null or #{p1.batch} = '')                                                                                      "
            + "      <if test='p1.status_list != null and p1.status_list.length!=0' >                                                                                                                           "
            + "       and t.status in                                                                                                                                                                           "
            + "           <foreach collection='p1.status_list' item='item' index='index' open='(' separator=',' close=')'>                                                                                      "
            + "            #{item}                                                                                                                                                                              "
            + "           </foreach>                                                                                                                                                                            "
            + "      </if>                                                                                                                                                                                      "
            + "      <if test='p1.type_list != null and p1.type_list.length!=0' >                                                                                                                               "
            + "       and t.type in                                                                                                                                                                             "
            + "           <foreach collection='p1.type_list' item='item' index='index' open='(' separator=',' close=')'>                                                                                        "
            + "            #{item}                                                                                                                                                                              "
            + "           </foreach>                                                                                                                                                                            "
            + "      </if>                                                                                                                                                                                      "
            + "      and (t.vehicle_no like concat('%', #{p1.vehicle_no}, '%') or #{p1.vehicle_no} is null or #{p1.vehicle_no} = '')                                                                            "
            + "      and (t9.warehouse_type = #{p1.warehouse_type} or #{p1.warehouse_type} is null or #{p1.warehouse_type} = '')                                                                                "
            //注意 exists里面使用count(1)需要配合分组使用 or 返回 IF(count( 1 )<1,NULL,true)
            + "    <if test='p1.todo_status == 0' >                                                                                                                                                             "
            + "  and exists (                                                                                                                                                                                   "
            + "		SELECT                                                                                                                                                                                      "
            + "				count(1)                                                                                                                                                                            "
            + "			FROM                                                                                                                                                                                    "
            + "				b_todo subt1                                                                                                                                                                        "
            + "				INNER JOIN v_permission_operation_all subt2 ON subt2.staff_id = #{p1.staff_id,jdbcType=INTEGER}                                                                                     "
            + "				AND subt1.position_id = subt2.position_id                                                                                                                                           "
            + "				AND subt2.operation_perms = subt1.perms                                                                                                                                             "
            + "			WHERE                                                                                                                                                                                   "
            + "				t.id = subt1.serial_id                                                                                                                                                              "
            + "				AND subt1.serial_type = '"+ SystemConstants.SERIAL_TYPE.B_RECEIVE+"'                                                                                                                "
            + "				AND subt1.STATUS = '"+ DictConstant.DICT_B_TODO_STATUS_TODO+"'                                                                                                                      "
            + "				GROUP BY subt1.serial_id, subt1.serial_type                                                                                                                                         "
            + "  )                                                                                                                                                                                              "
            + "      </if>                                                                                                                                                                                      "

            // 已办
            + "      <if test='p1.todo_status == 1' >                                                                                                                                                           "
            + "      and exists (                                                                                                                                                                               "
            + "             select count(1)                                                                                                                                                                     "
            + "               from b_already_do subt1                                                                                                                                                           "
            + "              where subt1.serial_type = '" + SystemConstants.SERIAL_TYPE.B_RECEIVE + "'                                                                                                          "
            + "                and subt1.staff_id = #{p1.staff_id,jdbcType=INTEGER}                                                                                                                             "
            + "                and serial_id = t.id                                                                                                                                                             "
            + "				GROUP BY subt1.serial_id, subt1.serial_type                                                                                                                                         "
            + "       )                                                                                                                                                                                         "
            + "      </if>                                                                                                                                                                                      "

            // 仓库权限
            + "     ${p1.params.dataScopeAnnotation}                                                                                                                                                            "
            + "      </script> ")
    Long selectPageMyCount(@Param("p1") BReceiveVo searchCondition);

    @Select(" <script>   "
            + " ${p1.params.dataScopeAnnotation_with}                                                                                                                                 "
            + " SELECT                                                                                                                                                                "
            + "   count(1) c                                                                                                                                                          "
            + "   FROM                                                                                                                                                                "
            + "         	b_receive t                                                                                                                                               "
            + "   LEFT JOIN m_staff t1 ON t.c_id = t1.id                                                                                                                              "
            + "   LEFT JOIN m_staff t2 ON t.u_id = t2.id                                                                                                                              "
            + "   LEFT JOIN m_staff t14 ON t.e_id = t14.id                                                                                                                            "
            + "   LEFT JOIN b_out_plan_detail t13 ON t.plan_detail_id = t13.id                                                                                                        "
            + "   LEFT JOIN b_out_plan t3 ON t.plan_id = t3.id                                                                                                                        "
            + "   LEFT JOIN b_order t19 on t13.order_id = t19.serial_id and t13.order_type = t19.serial_type                                                                          "
            + "   LEFT JOIN m_customer tt2 ON tt2.id = t19.customer_id                                                                                                                "
            + "   LEFT JOIN m_customer t4 ON t.consignor_id = t4.id                                                                                                                   "
            + "   LEFT JOIN m_owner t5 ON t.owner_id = t5.id                                                                                                                          "
            + "   LEFT JOIN m_bin t7 ON t.bin_id = t7.id                                                                                                                              "
            + "   LEFT JOIN m_location t8 ON t.location_id = t8.id                                                                                                                    "
            + "   LEFT JOIN m_warehouse t9 ON t.warehouse_id = t9.id                                                                                                                  "
            + "   LEFT JOIN m_goods_spec t11 ON t11.id = t.sku_id                                                                                                                     "
            + "   LEFT JOIN m_goods_spec_prop t24 ON t11.prop_id = t24.id      "
            + "   LEFT JOIN m_goods t12 ON t12.id = t11.goods_id                                                                                                                      "
            + "   LEFT JOIN (select tab1.out_photo_file, tab1.pound_file, tab1.contract_no, tab1.contract_num, tab1.contract_dt, tab1.receive_id, tab1.bill_type, tab3.label, tab2.name   "
            + "               from b_receive_extra tab1 left join m_customer tab2 on tab1.client_id = tab2.id                                                                             "
            + "              left join (select tab1.dict_value, tab1.label from s_dict_data tab1 inner join s_dict_type tab2 on tab1.dict_type_id = tab2.id                           "
            + "              where tab2.code = '" + DictConstant.DICT_B_RECEIVE_BUSINESS_TYPE + "') tab3 ON tab3.dict_value = tab1.bill_type ) t10 ON t10.receive_id = t.id               "
            + "   LEFT JOIN (select tab1.* from s_dict_data tab1 inner join s_dict_type tab2 on tab1.dict_type_id = tab2.id                                                           "
            + "              where tab2.code = '" + DictConstant.DICT_B_RECEIVE_STATUS + "')t15 on t15.dict_value = t.status                                                          "
            + "   LEFT JOIN (select tab1.* from s_dict_data tab1 inner join s_dict_type tab2 on tab1.dict_type_id = tab2.id                                                           "
            + "              where tab2.code = '" + DictConstant.DICT_B_RECEIVE_BUSINESS_TYPE + "')t16 ON t16.dict_value = t19.bill_type                                              "
            + "   LEFT JOIN (select tab1.* from s_dict_data tab1 inner join s_dict_type tab2 on tab1.dict_type_id = tab2.id                                                           "
            + "              where tab2.code = '" + DictConstant.DICT_B_RECEIVE_TYPE + "')t17 ON t17.dict_value = t3.type                                                             "
            + "   LEFT JOIN m_unit t20 ON t20.id = t.unit_id                                                                                                                          "
            + "   LEFT JOIN m_cancel t21 ON t21.serial_id = t.id and t21.serial_type = '" + SystemConstants.SERIAL_TYPE.B_OUT + "'                                                    "
            + "   LEFT JOIN (select tab1.* from s_dict_data tab1 inner join s_dict_type tab2 on tab1.dict_type_id = tab2.id                                                           "
            + "              where tab2.code = '" + DictConstant.DICT_B_RECEIVE_TYPE + "')t22 ON t22.dict_value = t.type                                                              "
            + "   LEFT JOIN b_sync_status_error t25 ON t.sync_id = t25.id                                                                                                             "
            + "   left join m_staff t27 ON t27.id = t.cancel_audit_id                                                                                                                 "
            + "   where true                                                                                                                                                          "
            + "      and (t.code like CONCAT ('%',#{p1.code,jdbcType=VARCHAR},'%') or #{p1.code,jdbcType=VARCHAR} is null or #{p1.code,jdbcType=VARCHAR} = '')                                                  "
            + "      and (t3.code like CONCAT ('%',#{p1.plan_code,jdbcType=VARCHAR},'%') or #{p1.plan_code,jdbcType=VARCHAR} is null or #{p1.plan_code,jdbcType=VARCHAR} = '')                                  "
            + "      and (CONCAT(t5.name,t5.short_name,t5.name_pinyin,t5.short_name_pinyin) like CONCAT ('%',#{p1.owner_name,jdbcType=VARCHAR},'%') or #{p1.owner_name,jdbcType=VARCHAR} is null)               "
            + "      and (CONCAT(t4.name,t4.short_name,t4.name_pinyin,t4.short_name_pinyin) like CONCAT ('%',#{p1.consignor_name,jdbcType=VARCHAR},'%') or #{p1.consignor_name,jdbcType=VARCHAR} is null)       "
            + "      and (t.warehouse_id = #{p1.warehouse_id,jdbcType=INTEGER} or #{p1.warehouse_id,jdbcType=INTEGER} is null)                                                                                  "
            + "      and (t3.type = #{p1.type,jdbcType=VARCHAR} or #{p1.type,jdbcType=VARCHAR} is null or #{p1.type,jdbcType=VARCHAR} = '')                                                                     "
            + "      and (t13.type_gauge like CONCAT ('%',#{p1.type_gauge,jdbcType=VARCHAR},'%') or #{p1.type_gauge,jdbcType=VARCHAR} is null or #{p1.type_gauge,jdbcType=VARCHAR} = '')                        "
            + "      and (t13.alias like CONCAT ('%',#{p1.alias,jdbcType=VARCHAR},'%') or #{p1.alias,jdbcType=VARCHAR} is null or #{p1.alias,jdbcType=VARCHAR} = '')                                            "
            + "      and (ifnull(t19.bill_type, t10.bill_type) = #{p1.bill_type,jdbcType=VARCHAR} or #{p1.bill_type,jdbcType=VARCHAR} is null or #{p1.bill_type,jdbcType=VARCHAR} ='')                          "
            + "      and (t.status = #{p1.status,jdbcType=VARCHAR} or #{p1.status,jdbcType=VARCHAR} is null or #{p1.status,jdbcType=VARCHAR} = '')                                                              "
            + "      and (t12.name like CONCAT ('%',#{p1.goods_name,jdbcType=VARCHAR},'%')                                                                                                                      "
            + "           or t11.spec like CONCAT ('%',#{p1.goods_name,jdbcType=VARCHAR},'%')                                                                                                                   "
            + "           or t.sku_code like CONCAT ('%',#{p1.goods_name,jdbcType=VARCHAR},'%')                                                                                                                 "
            + "           or t12.code like CONCAT ('%',#{p1.goods_name,jdbcType=VARCHAR},'%') or #{p1.goods_name,jdbcType=VARCHAR} is null or #{p1.goods_name,jdbcType=VARCHAR} = ''  )                         "
            + "      and (ifnull(t19.contract_no, t10.contract_no) like CONCAT ('%',#{p1.contract_no,jdbcType=VARCHAR},'%')  or #{p1.contract_no,jdbcType=VARCHAR} is null)                                     "
            + "      and (date_format(t.outbound_time, '%Y-%m-%d') &gt;= date_format(#{p1.start_time,jdbcType=DATE}, '%Y-%m-%d') or #{p1.start_time,jdbcType=DATE} is null)                                     "
            + "      and (date_format(t.outbound_time, '%Y-%m-%d') &lt;= date_format(#{p1.over_time,jdbcType=DATE}, '%Y-%m-%d') or #{p1.over_time,jdbcType=DATE} is null)                                       "
            + "      and (date_format(t.e_dt, '%Y-%m-%d') &gt;= #{p1.ed_dt_start} or #{p1.ed_dt_start} is null)                                                                                                 "
            + "      and (date_format(t.e_dt, '%Y-%m-%d') &lt;= #{p1.ed_dt_end} or #{p1.ed_dt_end} is null)                                                                                                     "
            + "      and (t24.name like concat('%', #{p1.prop}, '%') or #{p1.prop} is null or #{p1.prop} = '')                                                                                                  "
            + "      and (ifnull(tt2.name, t10.name) like concat('%', #{p1.client_name}, '%') or #{p1.client_name} is null or #{p1.client_name} = '')                                                           "
            + "      and (t25.status = #{p1.sync_status} or #{p1.sync_status} is null or #{p1.sync_status} = '')                                                                                                "
            + "      and (date_format(t.c_time, '%Y-%m-%d') &gt;= date_format(#{p1.c_time_start}, '%Y-%m-%d') or #{p1.c_time_start} is null)                                                                    "
            + "      and (date_format(t.c_time, '%Y-%m-%d') &lt;= date_format(#{p1.c_time_end}, '%Y-%m-%d') or #{p1.c_time_end} is null)                                                                        "
            + "      and (DATE_FORMAT(t.c_time, '%Y-%m-%d' ) &gt;= #{p1.batch} or #{p1.batch} is null or #{p1.batch} = '')                                                                                      "
            + "      <if test='p1.status_list != null and p1.status_list.length!=0' >                                                                                                                           "
            + "       and t.status in                                                                                                                                                                           "
            + "           <foreach collection='p1.status_list' item='item' index='index' open='(' separator=',' close=')'>                                                                                      "
            + "            #{item}                                                                                                                                                                              "
            + "           </foreach>                                                                                                                                                                            "
            + "      </if>                                                                                                                                                                                      "
            + "      <if test='p1.type_list != null and p1.type_list.length!=0' >                                                                                                                               "
            + "       and t.type in                                                                                                                                                                             "
            + "           <foreach collection='p1.type_list' item='item' index='index' open='(' separator=',' close=')'>                                                                                        "
            + "            #{item}                                                                                                                                                                              "
            + "           </foreach>                                                                                                                                                                            "
            + "      </if>                                                                                                                                                                                      "
            + "      and (t.vehicle_no like concat('%', #{p1.vehicle_no}, '%') or #{p1.vehicle_no} is null or #{p1.vehicle_no} = '')                                                                            "
            + "      and (t9.warehouse_type = #{p1.warehouse_type} or #{p1.warehouse_type} is null or #{p1.warehouse_type} = '')                                                                                "
            //注意 exists里面使用count(1)需要配合分组使用 or 返回 IF(count( 1 )<1,NULL,true)
            + "  and exists (                                                                                                                                                                                   "
            + "		SELECT                                                                                                                                                                                      "
            + "				count(1)                                                                                                                                                                            "
            + "			FROM                                                                                                                                                                                    "
            + "				b_todo subt1                                                                                                                                                                        "
            + "				INNER JOIN v_permission_operation_all subt2 ON subt2.staff_id = #{p1.staff_id,jdbcType=INTEGER}                                                                                     "
            + "				AND subt1.position_id = subt2.position_id                                                                                                                                           "
            + "				AND subt2.operation_perms = subt1.perms                                                                                                                                             "
            + "			WHERE                                                                                                                                                                                   "
            + "				t.id = subt1.serial_id                                                                                                                                                              "
            + "				AND subt1.serial_type = '"+ SystemConstants.SERIAL_TYPE.B_RECEIVE+"'                                                                                                                "
            + "				AND subt1.STATUS = '"+ DictConstant.DICT_B_TODO_STATUS_TODO+"'                                                                                                                      "
            + "				GROUP BY subt1.serial_id, subt1.serial_type                                                                                                                                         "
            + "  )                                                                                                                                                                                              "
            // 仓库权限
            + "     ${p1.params.dataScopeAnnotation}                                                                                                                                                            "
            + "      </script> ")
    Integer selectTodoCount(@Param("p1")BReceiveVo searchCondition);

    @Select(" <script>   "
            + " ${p1.params.dataScopeAnnotation_with}                                                                                                                                 "
            + " SELECT                                                                                                                                                                "
            + "             sum(t.actual_count) actual_count,                                                                                       "
            + "             sum(t.amount) amount                                                                                                   "
            + "   FROM                                                                                                                                                                "
            + "         	b_receive t                                                                                                                                               "
            + "   LEFT JOIN m_staff t1 ON t.c_id = t1.id                                                                                                                              "
            + "   LEFT JOIN m_staff t2 ON t.u_id = t2.id                                                                                                                              "
            + "   LEFT JOIN m_staff t14 ON t.e_id = t14.id                                                                                                                            "
            + "   LEFT JOIN b_out_plan_detail t13 ON t.plan_detail_id = t13.id                                                                                                        "
            + "   LEFT JOIN b_out_plan t3 ON t.plan_id = t3.id                                                                                                                        "
            + "   LEFT JOIN b_order t19 on t13.order_id = t19.serial_id and t13.order_type = t19.serial_type                                                                          "
            + "   LEFT JOIN m_customer tt2 ON tt2.id = t19.customer_id                                                                                                                "
            + "   LEFT JOIN m_customer t4 ON t.consignor_id = t4.id                                                                                                                   "
            + "   LEFT JOIN m_owner t5 ON t.owner_id = t5.id                                                                                                                          "
            + "   LEFT JOIN m_bin t7 ON t.bin_id = t7.id                                                                                                                              "
            + "   LEFT JOIN m_location t8 ON t.location_id = t8.id                                                                                                                    "
            + "   LEFT JOIN m_warehouse t9 ON t.warehouse_id = t9.id                                                                                                                  "
            + "   LEFT JOIN m_goods_spec t11 ON t11.id = t.sku_id                                                                                                                     "
            + "   LEFT JOIN m_goods_spec_prop t24 ON t11.prop_id = t24.id      "
            + "   LEFT JOIN m_goods t12 ON t12.id = t11.goods_id                                                                                                                      "
            + "   LEFT JOIN (select tab1.out_photo_file, tab1.pound_file, tab1.contract_no, tab1.contract_num, tab1.contract_dt, tab1.receive_id, tab1.bill_type, tab3.label, tab2.name   "
            + "               from b_receive_extra tab1 left join m_customer tab2 on tab1.client_id = tab2.id                                                                             "
            + "              left join (select tab1.dict_value, tab1.label from s_dict_data tab1 inner join s_dict_type tab2 on tab1.dict_type_id = tab2.id                           "
            + "              where tab2.code = '" + DictConstant.DICT_B_RECEIVE_BUSINESS_TYPE + "') tab3 ON tab3.dict_value = tab1.bill_type ) t10 ON t10.receive_id = t.id               "
            + "   LEFT JOIN (select tab1.* from s_dict_data tab1 inner join s_dict_type tab2 on tab1.dict_type_id = tab2.id                                                           "
            + "              where tab2.code = '" + DictConstant.DICT_B_RECEIVE_STATUS + "')t15 on t15.dict_value = t.status                                                          "
            + "   LEFT JOIN (select tab1.* from s_dict_data tab1 inner join s_dict_type tab2 on tab1.dict_type_id = tab2.id                                                           "
            + "              where tab2.code = '" + DictConstant.DICT_B_RECEIVE_BUSINESS_TYPE + "')t16 ON t16.dict_value = t19.bill_type                                              "
            + "   LEFT JOIN (select tab1.* from s_dict_data tab1 inner join s_dict_type tab2 on tab1.dict_type_id = tab2.id                                                           "
            + "              where tab2.code = '" + DictConstant.DICT_B_RECEIVE_TYPE + "')t17 ON t17.dict_value = t3.type                                                             "
            + "   LEFT JOIN m_unit t20 ON t20.id = t.unit_id                                                                                                                          "
            + "   LEFT JOIN m_cancel t21 ON t21.serial_id = t.id and t21.serial_type = '" + SystemConstants.SERIAL_TYPE.B_OUT + "'                                                    "
            + "   LEFT JOIN (select tab1.* from s_dict_data tab1 inner join s_dict_type tab2 on tab1.dict_type_id = tab2.id                                                           "
            + "              where tab2.code = '" + DictConstant.DICT_B_RECEIVE_TYPE + "')t22 ON t22.dict_value = t.type                                                              "
            + "   LEFT JOIN b_sync_status_error t25 ON t.sync_id = t25.id                                                                                                             "
            + "   left join m_staff t27 ON t27.id = t.cancel_audit_id                                                                                                                 "
            + "   where true                                                                                                                                                          "
            + "      and (t.code like CONCAT ('%',#{p1.code,jdbcType=VARCHAR},'%') or #{p1.code,jdbcType=VARCHAR} is null or #{p1.code,jdbcType=VARCHAR} = '')                                                  "
            + "      and (t3.code like CONCAT ('%',#{p1.plan_code,jdbcType=VARCHAR},'%') or #{p1.plan_code,jdbcType=VARCHAR} is null or #{p1.plan_code,jdbcType=VARCHAR} = '')                                  "
            + "      and (CONCAT(t5.name,t5.short_name,t5.name_pinyin,t5.short_name_pinyin) like CONCAT ('%',#{p1.owner_name,jdbcType=VARCHAR},'%') or #{p1.owner_name,jdbcType=VARCHAR} is null)               "
            + "      and (CONCAT(t4.name,t4.short_name,t4.name_pinyin,t4.short_name_pinyin) like CONCAT ('%',#{p1.consignor_name,jdbcType=VARCHAR},'%') or #{p1.consignor_name,jdbcType=VARCHAR} is null)       "
            + "      and (t.warehouse_id = #{p1.warehouse_id,jdbcType=INTEGER} or #{p1.warehouse_id,jdbcType=INTEGER} is null)                                                                                  "
            + "      and (t3.type = #{p1.type,jdbcType=VARCHAR} or #{p1.type,jdbcType=VARCHAR} is null or #{p1.type,jdbcType=VARCHAR} = '')                                                                     "
            + "      and (t13.type_gauge like CONCAT ('%',#{p1.type_gauge,jdbcType=VARCHAR},'%') or #{p1.type_gauge,jdbcType=VARCHAR} is null or #{p1.type_gauge,jdbcType=VARCHAR} = '')                        "
            + "      and (t13.alias like CONCAT ('%',#{p1.alias,jdbcType=VARCHAR},'%') or #{p1.alias,jdbcType=VARCHAR} is null or #{p1.alias,jdbcType=VARCHAR} = '')                                            "
            + "      and (ifnull(t19.bill_type, t10.bill_type) = #{p1.bill_type,jdbcType=VARCHAR} or #{p1.bill_type,jdbcType=VARCHAR} is null or #{p1.bill_type,jdbcType=VARCHAR} ='')                          "
            + "      and (t.status = #{p1.status,jdbcType=VARCHAR} or #{p1.status,jdbcType=VARCHAR} is null or #{p1.status,jdbcType=VARCHAR} = '')                                                              "
            + "      and (t12.name like CONCAT ('%',#{p1.goods_name,jdbcType=VARCHAR},'%')                                                                                                                      "
            + "           or t11.spec like CONCAT ('%',#{p1.goods_name,jdbcType=VARCHAR},'%')                                                                                                                   "
            + "           or t.sku_code like CONCAT ('%',#{p1.goods_name,jdbcType=VARCHAR},'%')                                                                                                                 "
            + "           or t12.code like CONCAT ('%',#{p1.goods_name,jdbcType=VARCHAR},'%') or #{p1.goods_name,jdbcType=VARCHAR} is null or #{p1.goods_name,jdbcType=VARCHAR} = ''  )                         "
            + "      and (ifnull(t19.contract_no, t10.contract_no) like CONCAT ('%',#{p1.contract_no,jdbcType=VARCHAR},'%')  or #{p1.contract_no,jdbcType=VARCHAR} is null)                                     "
            + "      and (date_format(t.outbound_time, '%Y-%m-%d') &gt;= date_format(#{p1.start_time,jdbcType=DATE}, '%Y-%m-%d') or #{p1.start_time,jdbcType=DATE} is null)                                     "
            + "      and (date_format(t.outbound_time, '%Y-%m-%d') &lt;= date_format(#{p1.over_time,jdbcType=DATE}, '%Y-%m-%d') or #{p1.over_time,jdbcType=DATE} is null)                                       "
            + "      and (date_format(t.e_dt, '%Y-%m-%d') &gt;= #{p1.ed_dt_start} or #{p1.ed_dt_start} is null)                                                                                                 "
            + "      and (date_format(t.e_dt, '%Y-%m-%d') &lt;= #{p1.ed_dt_end} or #{p1.ed_dt_end} is null)                                                                                                     "
            + "      and (t24.name like concat('%', #{p1.prop}, '%') or #{p1.prop} is null or #{p1.prop} = '')                                                                                                  "
            + "      and (ifnull(tt2.name, t10.name) like concat('%', #{p1.client_name}, '%') or #{p1.client_name} is null or #{p1.client_name} = '')                                                           "
            + "      and (t25.status = #{p1.sync_status} or #{p1.sync_status} is null or #{p1.sync_status} = '')                                                                                                "
            + "      and (date_format(t.c_time, '%Y-%m-%d') &gt;= date_format(#{p1.c_time_start}, '%Y-%m-%d') or #{p1.c_time_start} is null)                                                                    "
            + "      and (date_format(t.c_time, '%Y-%m-%d') &lt;= date_format(#{p1.c_time_end}, '%Y-%m-%d') or #{p1.c_time_end} is null)                                                                        "
            + "      and (DATE_FORMAT(t.c_time, '%Y-%m-%d' ) &gt;= #{p1.batch} or #{p1.batch} is null or #{p1.batch} = '')                                                                                      "
            + "      <if test='p1.status_list != null and p1.status_list.length!=0' >                                                                                                                           "
            + "       and t.status in                                                                                                                                                                           "
            + "           <foreach collection='p1.status_list' item='item' index='index' open='(' separator=',' close=')'>                                                                                      "
            + "            #{item}                                                                                                                                                                              "
            + "           </foreach>                                                                                                                                                                            "
            + "      </if>                                                                                                                                                                                      "
            + "      <if test='p1.type_list != null and p1.type_list.length!=0' >                                                                                                                               "
            + "       and t.type in                                                                                                                                                                             "
            + "           <foreach collection='p1.type_list' item='item' index='index' open='(' separator=',' close=')'>                                                                                        "
            + "            #{item}                                                                                                                                                                              "
            + "           </foreach>                                                                                                                                                                            "
            + "      </if>                                                                                                                                                                                      "
            + "      and (t.vehicle_no like concat('%', #{p1.vehicle_no}, '%') or #{p1.vehicle_no} is null or #{p1.vehicle_no} = '')                                                                            "
            + "      and (t9.warehouse_type = #{p1.warehouse_type} or #{p1.warehouse_type} is null or #{p1.warehouse_type} = '')                                                                                "
            //注意 exists里面使用count(1)需要配合分组使用 or 返回 IF(count( 1 )<1,NULL,true)
            + "    <if test='p1.todo_status == 0' >                                                                                                                                                             "
            + "  and exists (                                                                                                                                                                                   "
            + "		SELECT                                                                                                                                                                                      "
            + "				count(1)                                                                                                                                                                            "
            + "			FROM                                                                                                                                                                                    "
            + "				b_todo subt1                                                                                                                                                                        "
            + "				INNER JOIN v_permission_operation_all subt2 ON subt2.staff_id = #{p1.staff_id,jdbcType=INTEGER}                                                                                     "
            + "				AND subt1.position_id = subt2.position_id                                                                                                                                           "
            + "				AND subt2.operation_perms = subt1.perms                                                                                                                                             "
            + "			WHERE                                                                                                                                                                                   "
            + "				t.id = subt1.serial_id                                                                                                                                                              "
            + "				AND subt1.serial_type = '"+ SystemConstants.SERIAL_TYPE.B_RECEIVE+"'                                                                                                                "
            + "				AND subt1.STATUS = '"+ DictConstant.DICT_B_TODO_STATUS_TODO+"'                                                                                                                      "
            + "				GROUP BY subt1.serial_id, subt1.serial_type                                                                                                                                         "
            + "  )                                                                                                                                                                                              "
            + "      </if>                                                                                                                                                                                      "

            // 已办
            + "      <if test='p1.todo_status == 1' >                                                                                                                                                           "
            + "      and exists (                                                                                                                                                                               "
            + "             select count(1)                                                                                                                                                                     "
            + "               from b_already_do subt1                                                                                                                                                           "
            + "              where subt1.serial_type = '" + SystemConstants.SERIAL_TYPE.B_RECEIVE + "'                                                                                                          "
            + "                and subt1.staff_id = #{p1.staff_id,jdbcType=INTEGER}                                                                                                                             "
            + "                and serial_id = t.id                                                                                                                                                             "
            + "				GROUP BY subt1.serial_id, subt1.serial_type                                                                                                                                         "
            + "       )                                                                                                                                                                                         "
            + "      </if>                                                                                                                                                                                      "

            // 仓库权限
            + "     ${p1.params.dataScopeAnnotation}                                                                                                                                                            "
            + "      </script> ")
    BReceiveSumVo selectSumData(@Param("p1") BReceiveVo searchCondition);


    @Select(select_sql + " AND t.id= #{p1} ")
    BReceiveVo selectId(@Param("p1") Integer id);

    @Select("   <script>   "
            + select_sql
            + "  and t.id in                                                                                          "
            + "        <foreach collection='p1' item='item' index='index' open='(' separator=',' close=')'>             "
            + "         #{item.id,jdbcType=INTEGER}                                                                     "
            + "        </foreach>                                                                                       "
            + "  </script>    ")
    List<BReceiveEntity> selectIds(@Param("p1") List<BReceiveVo> searchCondition);

    @Select("   "
            + select_sql
            + "   and (t.id = #{p1.id,jdbcType=INTEGER} or #{p1.id,jdbcType=INTEGER} is null)                         "
            + "       ")
    List<BReceiveVo> selectListById(BReceiveVo vo);

    @Select(" <script>   "
            + select_sql
            + "   <if test='p1 != null and p1.length!=0' >                                                     "
            + "    and t.id in                                                                                 "
            + "        <foreach collection='p1' item='item' index='index' open='(' separator=',' close=')'>    "
            + "         #{item.id,jdbcType=INTEGER}  "
            + "        </foreach>    "
            + "   </if>                                                                                        "
            + "    </script>    ")
    List<BReceiveExportVo> selectExportList(@Param("p1") BReceiveVo[] list);

    @Select(" <script>   "
            + " ${p1.params.dataScopeAnnotation_with}                                                                                                                                                           "
            +        select_sql
            + "      and (t.code like CONCAT ('%',#{p1.code,jdbcType=VARCHAR},'%') or #{p1.code,jdbcType=VARCHAR} is null or #{p1.code,jdbcType=VARCHAR} = '')                                                  "
            + "      and (t3.code like CONCAT ('%',#{p1.plan_code,jdbcType=VARCHAR},'%') or #{p1.plan_code,jdbcType=VARCHAR} is null or #{p1.plan_code,jdbcType=VARCHAR} = '')                                  "
            + "      and (CONCAT(t5.name,t5.short_name,t5.name_pinyin,t5.short_name_pinyin) like CONCAT ('%',#{p1.owner_name,jdbcType=VARCHAR},'%') or #{p1.owner_name,jdbcType=VARCHAR} is null)               "
            + "      and (CONCAT(t4.name,t4.short_name,t4.name_pinyin,t4.short_name_pinyin) like CONCAT ('%',#{p1.consignor_name,jdbcType=VARCHAR},'%') or #{p1.consignor_name,jdbcType=VARCHAR} is null)       "
            + "      and (t.warehouse_id = #{p1.warehouse_id,jdbcType=INTEGER} or #{p1.warehouse_id,jdbcType=INTEGER} is null)                                                                                  "
            + "      and (t3.type = #{p1.type,jdbcType=VARCHAR} or #{p1.type,jdbcType=VARCHAR} is null or #{p1.type,jdbcType=VARCHAR} = '')                                                                     "
            + "      and (t13.type_gauge like CONCAT ('%',#{p1.type_gauge,jdbcType=VARCHAR},'%') or #{p1.type_gauge,jdbcType=VARCHAR} is null or #{p1.type_gauge,jdbcType=VARCHAR} = '')                        "
            + "      and (t13.alias like CONCAT ('%',#{p1.alias,jdbcType=VARCHAR},'%') or #{p1.alias,jdbcType=VARCHAR} is null or #{p1.alias,jdbcType=VARCHAR} = '')                                            "
            + "      and (ifnull(t19.bill_type, t10.bill_type) = #{p1.bill_type,jdbcType=VARCHAR} or #{p1.bill_type,jdbcType=VARCHAR} is null or #{p1.bill_type,jdbcType=VARCHAR} ='')                          "
            + "      and (t.status = #{p1.status,jdbcType=VARCHAR} or #{p1.status,jdbcType=VARCHAR} is null or #{p1.status,jdbcType=VARCHAR} = '')                                                              "
            + "      and (t12.name like CONCAT ('%',#{p1.goods_name,jdbcType=VARCHAR},'%')                                                                                                                      "
            + "           or t11.spec like CONCAT ('%',#{p1.goods_name,jdbcType=VARCHAR},'%')                                                                                                                   "
            + "           or t.sku_code like CONCAT ('%',#{p1.goods_name,jdbcType=VARCHAR},'%')                                                                                                                 "
            + "           or t12.code like CONCAT ('%',#{p1.goods_name,jdbcType=VARCHAR},'%') or #{p1.goods_name,jdbcType=VARCHAR} is null or #{p1.goods_name,jdbcType=VARCHAR} = ''  )                         "
            + "      and (ifnull(t19.contract_no, t10.contract_no) like CONCAT ('%',#{p1.contract_no,jdbcType=VARCHAR},'%')  or #{p1.contract_no,jdbcType=VARCHAR} is null)                                     "
            + "      and (date_format(t.outbound_time, '%Y-%m-%d') &gt;= date_format(#{p1.start_time,jdbcType=DATE}, '%Y-%m-%d') or #{p1.start_time,jdbcType=DATE} is null)                                     "
            + "      and (date_format(t.outbound_time, '%Y-%m-%d') &lt;= date_format(#{p1.over_time,jdbcType=DATE}, '%Y-%m-%d') or #{p1.over_time,jdbcType=DATE} is null)                                       "
            + "      and (date_format(t.e_dt, '%Y-%m-%d') &gt;= #{p1.ed_dt_start} or #{p1.ed_dt_start} is null)                                                                                                 "
            + "      and (date_format(t.e_dt, '%Y-%m-%d') &lt;= #{p1.ed_dt_end} or #{p1.ed_dt_end} is null)                                                                                                     "
            + "      and (t24.name like concat('%', #{p1.prop}, '%') or #{p1.prop} is null or #{p1.prop} = '')                                                                                                  "
            + "      and (ifnull(tt2.name, t10.name) like concat('%', #{p1.client_name}, '%') or #{p1.client_name} is null or #{p1.client_name} = '')                                                           "
            + "      and (t25.status = #{p1.sync_status} or #{p1.sync_status} is null or #{p1.sync_status} = '')                                                                                                "
            + "      and (date_format(t.c_time, '%Y-%m-%d') &gt;= date_format(#{p1.c_time_start}, '%Y-%m-%d') or #{p1.c_time_start} is null)                                                                    "
            + "      and (date_format(t.c_time, '%Y-%m-%d') &lt;= date_format(#{p1.c_time_end}, '%Y-%m-%d') or #{p1.c_time_end} is null)                                                                        "
            + "      and (DATE_FORMAT(t.c_time, '%Y-%m-%d' ) &gt;= #{p1.batch} or #{p1.batch} is null or #{p1.batch} = '')                                                                                      "
            + "      <if test='p1.status_list != null and p1.status_list.length!=0' >                                                                                                                           "
            + "       and t.status in                                                                                                                                                                           "
            + "           <foreach collection='p1.status_list' item='item' index='index' open='(' separator=',' close=')'>                                                                                      "
            + "            #{item}                                                                                                                                                                              "
            + "           </foreach>                                                                                                                                                                            "
            + "      </if>                                                                                                                                                                                      "
            + "      <if test='p1.type_list != null and p1.type_list.length!=0' >                                                                                                                               "
            + "       and t.type in                                                                                                                                                                             "
            + "           <foreach collection='p1.type_list' item='item' index='index' open='(' separator=',' close=')'>                                                                                        "
            + "            #{item}                                                                                                                                                                              "
            + "           </foreach>                                                                                                                                                                            "
            + "      </if>                                                                                                                                                                                      "
            + "      and (t.vehicle_no like concat('%', #{p1.vehicle_no}, '%') or #{p1.vehicle_no} is null or #{p1.vehicle_no} = '')                                                                            "
            + "      and (t9.warehouse_type = #{p1.warehouse_type} or #{p1.warehouse_type} is null or #{p1.warehouse_type} = '')                                                                                "
            //注意 exists里面使用count(1)需要配合分组使用 or 返回 IF(count( 1 )<1,NULL,true)
            + "    <if test='p1.todo_status == 0' >                                                                                                                                                             "
            + "  and exists (                                                                                                                                                                                   "
            + "		SELECT                                                                                                                                                                                      "
            + "				count(1)                                                                                                                                                                            "
            + "			FROM                                                                                                                                                                                    "
            + "				b_todo subt1                                                                                                                                                                        "
            + "				INNER JOIN v_permission_operation_all subt2 ON subt2.staff_id = #{p1.staff_id,jdbcType=INTEGER}                                                                                     "
            + "				AND subt1.position_id = subt2.position_id                                                                                                                                           "
            + "				AND subt2.operation_perms = subt1.perms                                                                                                                                             "
            + "			WHERE                                                                                                                                                                                   "
            + "				t.id = subt1.serial_id                                                                                                                                                              "
            + "				AND subt1.serial_type = '"+ SystemConstants.SERIAL_TYPE.B_RECEIVE+"'                                                                                                                "
            + "				AND subt1.STATUS = '"+ DictConstant.DICT_B_TODO_STATUS_TODO+"'                                                                                                                      "
            + "				GROUP BY subt1.serial_id, subt1.serial_type                                                                                                                                         "
            + "  )                                                                                                                                                                                              "
            + "      </if>                                                                                                                                                                                      "

            // 已办
            + "      <if test='p1.todo_status == 1' >                                                                                                                                                           "
            + "      and exists (                                                                                                                                                                               "
            + "             select count(1)                                                                                                                                                                     "
            + "               from b_already_do subt1                                                                                                                                                           "
            + "              where subt1.serial_type = '" + SystemConstants.SERIAL_TYPE.B_RECEIVE + "'                                                                                                          "
            + "                and subt1.staff_id = #{p1.staff_id,jdbcType=INTEGER}                                                                                                                             "
            + "                and serial_id = t.id                                                                                                                                                             "
            + "				GROUP BY subt1.serial_id, subt1.serial_type                                                                                                                                         "
            + "       )                                                                                                                                                                                         "
            + "      </if>                                                                                                                                                                                      "

            // 仓库权限
            + "     ${p1.params.dataScopeAnnotation}                                                                                                                                                            "
            + "      </script> ")
    List<BReceiveExportVo> selectExportAllList(BReceiveVo searchCondition);

    /**
     * 监管任务出库id查询出库单数据
     */
    @Select("                                                                                                                 "
            + "     SELECT                                                                                                    "
            + "            t4.type,                                                                                           "
            + "            t4.owner_id,                                                                                       "
            + "            t4.owner_code,                                                                                     "
            + "            t4.consignor_id,                                                                                   "
            + "            t4.consignor_code,                                                                                 "
            + "            t2.qty actual_weight,                                                                              "
            + "            t2.qty actual_count,                                                                               "
            + "            t3.weight plan_weight,                                                                             "
            + "            t3.weight plan_count,                                                                              "
            + "            '" + DictConstant.DICT_B_OUT_STATUS_SUBMITTED + "' as status,                                         "
            + "            t4.id as plan_id,                                                                                  "
            + "            t3.id as plan_detail_id,                                                                           "
            + "            t.out_warehouse_id warehouse_id,                                                                   "
            + "            t.out_location_id as location_id,                                                                  "
            + "            t.out_bin_id as bin_id,                                                                            "
            + "            t3.sku_id,                                                                                         "
            + "            t3.sku_code,                                                                                       "
            + "            t3.count as plan_count,                                                                            "
            + "            t3.weight as plan_weight,                                                                          "
            + "            t3.unit_id,                                                                                        "
            + "            t5.price,                                                                                          "
            + "            t5.price*t2.qty amount                                                                             "
            + "       FROM                                                                                                    "
            + "  	       b_schedule t                                                                                       "
            + "  LEFT JOIN b_monitor  t1 ON t1.schedule_id = t.id                                                             "
            + "  LEFT JOIN b_monitor_out  t2 ON t2.monitor_id = t1.id                                                         "
            + "  LEFT JOIN b_out_plan_detail  t3 ON t3.id = t.out_plan_detail_id                                              "
            + "  LEFT JOIN b_out_plan  t4 ON t4.id = t3.plan_id                                                               "
            + "  LEFT JOIN (                                                                                                  "
            + "		SELECT                                                                                                    "
            + "			t1.id,ifnull(t3.price, 0) price,t3.sku_id,t3.no                                                       "
            + "		FROM                                                                                                      "
            + "			b_order t1                                                                                            "
            + "			JOIN b_in_order t2 ON t1.serial_id = t2.id                                                            "
            + "			AND t1.serial_type = 'b_in_order'                                                                     "
            + "			LEFT JOIN b_in_order_goods t3 ON t2.id = t3.order_id                                                  "
            + "			union all                                                                                             "
            + "		SELECT                                                                                                    "
            + "			t1.id,ifnull(t3.price, 0) price,t3.sku_id,t3.no                                                       "
            + "		FROM                                                                                                      "
            + "			b_order t1                                                                                            "
            + "			JOIN b_out_order t2 ON t1.serial_id = t2.id                                                           "
            + "			AND t1.serial_type = 'b_out_order'                                                                    "
            + "			LEFT JOIN b_out_order_goods t3 ON t2.id = t3.order_id                                                 "
            + "     )t5 on t.order_id = t5.id   and t.sku_id = t5.sku_id and t3.order_detail_no = t5.no                       "
            + "     where true                                                                                                "
            + "     and t2.id = #{p1,jdbcType=INTEGER}                                                                        "
            + "  ")
    BReceiveEntity selectByMonitorOutId(@Param("p1") Integer id);
}
